======================
User's guide: wdPicker
======================

Analysis of the output files
############################

The script ``wdPicker.py`` allows to visualize and perform some analysis of WaveDec output files. It is also possible to save to disk figures and comma-separated values (CSV) files with picked curves.

The workflow is as follow:

* Quickly **plot** the WaveDec or WaveDecActive output files with no user intervention.

* Using a graphical interface, manually **select** the wavenumber ML estimates corresponding to the dispersion curve of a certain mode of propagation.

* For Rayleigh waves, manually select the ellipticity angle ML estimates of the ellipticity angle curve.

* The ML estimates of the selected dispersion curve (and eventually ellipticty angle curve) are saved to CSV file. (Same format of WaveDec output files).

* Automatically **pick** the median value of the filtered estimates for the dispersion curve or the ellipticity curve.


In each of these three steps, figures and CSV are generated and can be saved to file. To choose which files need to be saved to disk, see command line options (see inline help ``wdPicker.py -h``). In order to change default settings including figure output format (eg, PDF or PNG), resolution (dpi), input and output folders, edit the corresponding values in ``bin/wdSettings.py``.

Observe that the name of the WaveDec output files should not be changed as it is used by wdPicker.

.. note::
   Depending on the version of your libraries, several warning messages generated by Qt libraries while using ``wdPicker.py`` may be printed in the console. 
   The errors do not affect the functionalities but only represent a nuisance when reading the instructions from the console.

Plotting
********

``wdPicker.py`` immediately produces figures of all WaveDec output files in the current folder without requiring any user intervention.

Plots generated include:

* Array layout

* Dispersion curve, in wavenumber vs frequency and in velocity vs frequency

* Ellipticity angle curve for Rayleigh waves

* Azimuth vs frequency

Each ML estimate is depicted with a red dot. The density of the estimates is represented in the background using a color scale and is obtained using a standard non-parametric method, `kernel density estimation (KDE) <https://en.wikipedia.org/wiki/Kernel_density_estimation>`_. For quantities defined on angles (azimuth and ellipticity angle) the modularity is considered.

If the file ``ArrayResolutionLimits.csv`` is present, array resolution limits are overlaid to the dispersion curve.

These figures show together estimates belonging to multiple modes and outliers not belonging to any mode of propagation. In order to separate the modes, continue reading to the next section.

Filtering
*********

We now explain how it is possible to isolate a single mode of propagation and to reject outliers.

Considering the wavenumber-frequency plot, the user can select an upper and a lower bound containing the estimates of interest using the mouse. Once the selection is finalized, only the estimates between the bounds will be considered and the estimates outside will be disregarded.

During the filtering procedure, read and follow instructions given in console. The bounds are represented as piecewise linear functions. Pressing the mouse left button will add a new point, pressing the right button will remove the last point selected. When a bound is correctly selected, press the ``SPACE KEY`` to accept it.  Scrolling the mouse wheel or pressing the keys ``+`` and ``-`` it is possible to increase or reduce the width of the background estimate density.

For Love waves the selection is performed in the wavenumber-frequency plane. For Rayleigh waves the selection is first performed in the wavenumber-frequency plane and then in the ellipticity angle-frequency plane.

After the selection is done, more figures corresponding to the filtered points (i.e., the points within the selected bounds) are plotted and saved to file. 

Moreover CSV files with the same format of the WaveDec output files are generated. In these files, only the filtered estimates are present.


Picking
*******

In the last step, which requires no intervention from the user, the dispersion curve and the ellipticity angle curve are picked from the filtered estimates.

For dispersion curves, the median and the standard deviation of the filtered wavenumbers are computed.

For ellipticity angle curves, the circular median and the circular standard deviation of the filtered ellipticity angles are computed.

Picked curves are saved to a CSV file.

Several images are saved to file.

Options
*******

Some options for ``wdPicker`` can be set from command line. Help is shown with


.. code-block:: bash

  $ wdPicker.py --help


The default value for these options can be modified in the file ``wdSettings.py``.

Options include

* Image output format (png, pdf, ...) and resolution (dpi)

* Output folders for plots and CSV files

* Default bandwidth/variance used for visualization of the estimates


