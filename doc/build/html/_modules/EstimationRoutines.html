<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>EstimationRoutines &mdash; WaveDec  documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="WaveDec  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
<li><a href="http://mercalli.ethz.ch/~marra/">Home</a> &raquo; <a href="../index.html">WaveDec  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for EstimationRoutines</h1><div class="highlight"><pre>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">##################################################</span>
<span class="c1"># Â© 2017 ETH Zurich, Swiss Seismological Service #</span>
<span class="c1"># Stefano Marano&#39; - wavedec at gmail dot com     #</span>
<span class="c1">##################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Here are estimation routines used in WaveDec</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span> <span class="c1"># , approx_fprime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">shape</span><span class="p">,</span> <span class="n">fft</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">imag</span><span class="p">,</span> <span class="n">eye</span><span class="p">,</span> <span class="n">linalg</span><span class="p">,</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> \
        <span class="n">meshgrid</span><span class="p">,</span> <span class="n">concatenate</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">conjugate</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> \
        <span class="n">arctan2</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">argmin</span><span class="p">,</span> <span class="n">reshape</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">arange</span>
<span class="kn">import</span> <span class="nn">DataUtils</span> <span class="kn">as</span> <span class="nn">db</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">wdSettings</span> <span class="kn">import</span> <span class="n">MODEL_NOISE</span><span class="p">,</span> <span class="n">MODEL_VERTICAL</span><span class="p">,</span> <span class="n">MODEL_RAYLEIGH</span><span class="p">,</span> <span class="n">MODEL_LOVE</span>
<span class="kn">from</span> <span class="nn">wdSettings</span> <span class="kn">import</span> <span class="n">EWX</span><span class="p">,</span> <span class="n">NSY</span><span class="p">,</span> <span class="n">UDZ</span><span class="p">,</span> <span class="n">ROTX</span><span class="p">,</span> <span class="n">ROTY</span><span class="p">,</span> <span class="n">ROTZ</span>




<div class="viewcode-block" id="decomposeWavefield"><a class="viewcode-back" href="../code.html#EstimationRoutines.decomposeWavefield">[docs]</a><span class="k">def</span> <span class="nf">decomposeWavefield</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">WindowId</span><span class="p">,</span> <span class="n">Ts</span><span class="p">,</span> <span class="n">Fvec_ndx</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">Kstep</span><span class="p">,</span> <span class="n">Estep</span><span class="p">,</span> <span class="n">Vmin</span><span class="p">,</span> <span class="n">WavesToModel</span><span class="p">,</span> <span class="n">MaxWaves</span><span class="p">,</span> <span class="n">MaxIterations</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fit different wave types at several frequencies.</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    conn : </span>
<span class="sd">        SQL database connection</span>
<span class="sd">    y : float array</span>
<span class="sd">        input signal</span>
<span class="sd">    WindowId : int</span>
<span class="sd">        Unique indentifier of the window</span>
<span class="sd">    Ts : float</span>
<span class="sd">        Sampling time [s]</span>
<span class="sd">    Fvec_ndx : int array</span>
<span class="sd">        ...</span>
<span class="sd">    Kmax : float</span>
<span class="sd">        Largest wavenumber [1/m] to analyze</span>
<span class="sd">    Kstep : float</span>
<span class="sd">        Grid step in the wavenumber plane [1/m]</span>
<span class="sd">    Vmin : float</span>
<span class="sd">        Smallest velocity [m/s] to analyze</span>
<span class="sd">    WavesToModel : </span>
<span class="sd">        Describe which wave types should be fitted</span>
<span class="sd">    MaxWaves : int</span>
<span class="sd">        Maximum number of waves to model at each frequency in the time window</span>
<span class="sd">    MaxIterations : int</span>
<span class="sd">        Maximum number of interations. In each iteration parameters of each wave are re-estimated.</span>
<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd">    Gamma : float</span>
<span class="sd">        Controls model complexity. (0 for pure ML, 1 for BIC, other values for intermediate strategies)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">K</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Fvec_fft</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">Ts</span><span class="p">);</span>
    <span class="c1"># Fvec = Fvec_fft[Fvec_ndx]</span>
    
    <span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">)</span> <span class="o">=</span> <span class="n">bwMessages</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Ts</span><span class="p">)</span>
    <span class="n">Sm_fw_all</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">))</span>
    
        
    <span class="n">F</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    
    
    <span class="n">NumK</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ceil</span><span class="p">(</span><span class="n">Kmax</span><span class="o">/</span><span class="n">Kstep</span><span class="p">)</span> <span class="c1"># number of points in the wavenumber search grid. Even, so that we do not have 0 in the final search grid</span>
    <span class="n">NumE</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">Estep</span><span class="p">)</span> <span class="c1"># number of points in the ellipticity search grid Even, so that we have 0 in the final search grid</span>
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">NumK</span><span class="p">)</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">NumK</span><span class="p">)</span>
    <span class="n">EllipticityAngle</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">NumE</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">,</span><span class="n">Wavenumber_y</span><span class="p">,</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xx</span><span class="p">);</span> <span class="n">yy</span><span class="o">=</span><span class="n">concatenate</span><span class="p">(</span><span class="n">yy</span><span class="p">);</span> <span class="n">zz</span><span class="o">=</span><span class="n">concatenate</span><span class="p">(</span><span class="n">zz</span><span class="p">);</span>
    <span class="n">ndx_ok</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Kmax</span> <span class="c1"># only wavenumber smaller than Kmax</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">ndx_ok</span><span class="p">];</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">ndx_ok</span><span class="p">];</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">zz</span><span class="p">[</span><span class="n">ndx_ok</span><span class="p">];</span>
    <span class="n">X_grid_R</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">])</span> <span class="c1"># Rayleigh waves</span>
    
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">,</span><span class="n">Wavenumber_y</span><span class="p">)</span>
    <span class="n">xx</span><span class="o">=</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xx</span><span class="p">);</span> <span class="n">yy</span><span class="o">=</span><span class="n">concatenate</span><span class="p">(</span><span class="n">yy</span><span class="p">);</span>
    <span class="n">ndx_ok</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Kmax</span> <span class="c1"># only wavenumber smaller than Kmax</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">ndx_ok</span><span class="p">];</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">ndx_ok</span><span class="p">];</span>
    <span class="n">X_grid_L</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">])</span> <span class="c1"># Love waves</span>
    
    <span class="c1"># Fndx</span>
    <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">Fvec_ndx</span><span class="p">:</span>
        <span class="n">X_grid_R_f</span> <span class="o">=</span> <span class="n">X_grid_R</span>
        <span class="n">X_grid_L_f</span> <span class="o">=</span> <span class="n">X_grid_L</span>
        <span class="n">X_grid_V_f</span> <span class="o">=</span> <span class="n">X_grid_L</span>

        <span class="k">if</span> <span class="n">Vmin</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">Vmin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># further restrict search grid</span>
            <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_LOVE</span><span class="p">]</span> <span class="ow">or</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_VERTICAL</span><span class="p">]:</span>
                <span class="n">ndx_ok</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">X_grid_L</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">X_grid_L</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Fvec_fft</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">/</span><span class="n">Vmin</span>
                <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_LOVE</span><span class="p">]:</span>
                    <span class="n">X_grid_L_f</span> <span class="o">=</span> <span class="n">X_grid_L</span><span class="p">[:,</span><span class="n">ndx_ok</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_VERTICAL</span><span class="p">]:</span>
                    <span class="n">X_grid_V_f</span> <span class="o">=</span> <span class="n">X_grid_L</span><span class="p">[:,</span><span class="n">ndx_ok</span><span class="p">]</span>        
            <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_RAYLEIGH</span><span class="p">]:</span>
                <span class="n">ndx_ok</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">X_grid_R</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">X_grid_R</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Fvec_fft</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">/</span><span class="n">Vmin</span> 
                <span class="n">X_grid_R_f</span> <span class="o">=</span> <span class="n">X_grid_R</span><span class="p">[:,</span><span class="n">ndx_ok</span><span class="p">]</span>
 
        <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">MaxWaves</span><span class="p">))</span> <span class="c1"># shape() = (2,L,F)</span>
        <span class="n">WaveModel</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">MaxWaves</span><span class="p">,))</span>
        <span class="n">WaveAmplitude</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">MaxWaves</span><span class="p">,))</span>
        <span class="n">WavePhase</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">MaxWaves</span><span class="p">,))</span>
        <span class="n">WaveX_ML</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span> <span class="n">MaxWaves</span>
        
        <span class="c1"># gradually increase the number of waves modeled</span>
        <span class="n">NumWaves</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of waves modeled</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">MaxWaves</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fitting {0}-th model (at {1:.3f} [Hz])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mm</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Fvec_fft</span><span class="p">[</span><span class="n">ff</span><span class="p">]))</span>
            <span class="n">tmpBIC</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">tmpModel</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">tmpSm_bw</span> <span class="o">=</span> <span class="n">Sm_bw</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Sm_fw</span> <span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">mm</span><span class="p">]</span>
            <span class="c1"># how about variance messages?</span>
            
            <span class="c1"># Parameter estimation: attempt to fit different possible models</span>
            <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_NOISE</span><span class="p">]:</span>
                <span class="p">(</span><span class="n">BIC_N</span><span class="p">,</span> <span class="n">sigma2_ML</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitNoise</span><span class="p">(</span><span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                <span class="n">tmpBIC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BIC_N</span><span class="p">);</span> <span class="n">tmpModel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MODEL_NOISE</span><span class="p">);</span>               
            <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_VERTICAL</span><span class="p">]</span> <span class="ow">and</span> <span class="n">size</span><span class="p">(</span><span class="n">X_grid_V_f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="p">(</span><span class="n">BIC_V</span><span class="p">,</span> <span class="n">Sm_fw_V</span><span class="p">,</span> <span class="n">Amplitude_V</span><span class="p">,</span> <span class="n">Phase_V</span><span class="p">,</span> <span class="n">X_ML_V</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitVerticalWave</span><span class="p">(</span><span class="n">X_grid_V_f</span><span class="p">,</span> <span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                <span class="n">tmpBIC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BIC_V</span><span class="p">);</span> <span class="n">tmpModel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MODEL_VERTICAL</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_LOVE</span><span class="p">]</span> <span class="ow">and</span> <span class="n">size</span><span class="p">(</span><span class="n">X_grid_L_f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="p">(</span><span class="n">BIC_L</span><span class="p">,</span> <span class="n">Sm_fw_L</span><span class="p">,</span> <span class="n">Amplitude_L</span><span class="p">,</span> <span class="n">Phase_L</span><span class="p">,</span> <span class="n">X_ML_L</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitLoveWave</span><span class="p">(</span><span class="n">X_grid_L_f</span><span class="p">,</span> <span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                <span class="n">tmpBIC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BIC_L</span><span class="p">);</span> <span class="n">tmpModel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MODEL_LOVE</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">WavesToModel</span><span class="p">[</span><span class="n">MODEL_RAYLEIGH</span><span class="p">]</span> <span class="ow">and</span> <span class="n">size</span><span class="p">(</span><span class="n">X_grid_R_f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="p">(</span><span class="n">BIC_R</span><span class="p">,</span> <span class="n">Sm_fw_R</span><span class="p">,</span> <span class="n">Amplitude_R</span><span class="p">,</span> <span class="n">Phase_R</span><span class="p">,</span> <span class="n">X_ML_R</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitRayleighWave</span><span class="p">(</span><span class="n">X_grid_R_f</span><span class="p">,</span> <span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                <span class="n">tmpBIC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BIC_R</span><span class="p">);</span> <span class="n">tmpModel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MODEL_RAYLEIGH</span><span class="p">);</span>
            

            <span class="c1"># Model selection: choose wave with smallest BIC</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpBIC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpModel</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">tmpBIC</span><span class="p">)]</span>
                <span class="n">histBIC</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">MaxIterations</span><span class="o">+</span><span class="mi">1</span><span class="p">,))</span>
                <span class="n">histBIC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmpBIC</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_NOISE</span><span class="p">:</span>
                <span class="k">break</span>     <span class="c1"># when a noise model is chosen no more waves need to be added</span>
            <span class="k">if</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>     <span class="c1"># Nothing was modeled. Perhaps because of stringent Vmin at this frequency</span>
            <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_VERTICAL</span><span class="p">:</span>
                <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_V</span>
                <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amplitude_V</span>
                <span class="n">WavePhase</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phase_V</span>
                <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ML_V</span>
            <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_LOVE</span><span class="p">:</span>
                <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_L</span>
                <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amplitude_L</span>
                <span class="n">WavePhase</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phase_L</span>
                <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ML_L</span>
            <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_RAYLEIGH</span><span class="p">:</span>
                <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_R</span>
                <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amplitude_R</span>
                <span class="n">WavePhase</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phase_R</span>
                <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ML_R</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning: unrecognized wave model&quot;</span><span class="p">)</span>
                
            <span class="c1"># refine existing estimates, if needed</span>
            <span class="n">NumWaves</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">WaveModel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WaveModel</span> <span class="o">!=</span> <span class="n">MODEL_NOISE</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">MaxIterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">NumWaves</span>  <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">MaxIterations</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mm</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Refining estimates of model {0}/{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mm</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">tmpSm_bw</span> <span class="o">=</span> <span class="n">Sm_bw</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Sm_fw</span> <span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">m</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_NOISE</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_VERTICAL</span><span class="p">:</span>
                            <span class="n">X</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                            <span class="p">(</span><span class="n">BIC_V</span><span class="p">,</span> <span class="n">Sm_fw_V</span><span class="p">,</span> <span class="n">Amplitude_V</span><span class="p">,</span> <span class="n">Phase_v</span><span class="p">,</span> <span class="n">X_ML_V</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitVerticalWave</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                            <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ML_V</span>
                            <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amplitude_V</span>
                            <span class="n">WavePhase</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phase_V</span>
                            <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_V</span>
                        <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_LOVE</span><span class="p">:</span>
                            <span class="n">X</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                            <span class="p">(</span><span class="n">BIC_L</span><span class="p">,</span> <span class="n">Sm_fw_L</span><span class="p">,</span> <span class="n">Amplitude_L</span><span class="p">,</span> <span class="n">Phase_L</span><span class="p">,</span> <span class="n">X_ML_L</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitLoveWave</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                            <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ML_L</span>
                            <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amplitude_L</span>
                            <span class="n">WavePhase</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phase_L</span>
                            <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_L</span>
                        <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_RAYLEIGH</span><span class="p">:</span>
                            <span class="n">X</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                            <span class="p">(</span><span class="n">BIC_R</span><span class="p">,</span> <span class="n">Sm_fw_R</span><span class="p">,</span> <span class="n">Amplitude_R</span><span class="p">,</span> <span class="n">Phase_R</span><span class="p">,</span> <span class="n">X_ML_R</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitRayleighWave</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                            <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ML_R</span>
                            <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Amplitude_R</span>
                            <span class="n">WavePhase</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phase_R</span>
                            <span class="n">Sm_fw</span><span class="p">[:,:,:,</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_R</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unrecognized wave model {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">WaveModel</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span>
                    <span class="n">tmpSm_bw</span> <span class="o">=</span> <span class="n">Sm_bw</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Sm_fw</span> <span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">BIC_N</span><span class="p">,</span> <span class="n">sigma2_ML</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitNoise</span><span class="p">(</span><span class="n">tmpSm_bw</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
                    <span class="n">histBIC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIC_N</span> <span class="c1"># TODO is this the right BIC value, multiple waves are they all same?</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">histBIC</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">histBIC</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">histBIC</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                        <span class="k">break</span>

        <span class="c1"># Compute forward messages and estimated paramters</span>
        <span class="n">Sm_fw_all</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Sm_fw</span> <span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">NumWaves</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">WaveModel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WaveModel</span> <span class="o">!=</span> <span class="n">MODEL_NOISE</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NumWaves</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_NOISE</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_VERTICAL</span><span class="p">:</span>
                <span class="n">Kx</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ky</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">Kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Ky</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Ky</span><span class="p">,</span> <span class="n">Kx</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># Note the role reversal, as from documentation</span>
                <span class="n">db</span><span class="o">.</span><span class="n">addVerticalWave</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">WindowId</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">WavePhase</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">Wavenumber</span><span class="p">,</span> <span class="n">Azimuth</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_LOVE</span><span class="p">:</span>
                <span class="n">Kx</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ky</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">Kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Ky</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Ky</span><span class="p">,</span> <span class="n">Kx</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># Note the role reversal, as from documentation</span>
                <span class="n">db</span><span class="o">.</span><span class="n">addLoveWave</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">WindowId</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">WavePhase</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">Wavenumber</span><span class="p">,</span> <span class="n">Azimuth</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODEL_RAYLEIGH</span><span class="p">:</span>
                <span class="n">Kx</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ky</span> <span class="o">=</span> <span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">EllipticityAngle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">WaveX_ML</span><span class="p">[</span><span class="n">mm</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span>  <span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span> <span class="n">Kx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Ky</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Ky</span><span class="p">,</span> <span class="n">Kx</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># Note the role reversal, as from documentation</span>
                <span class="n">db</span><span class="o">.</span><span class="n">addRayleighWave</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">WindowId</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">WaveAmplitude</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">WavePhase</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">Wavenumber</span><span class="p">,</span> <span class="n">Azimuth</span><span class="p">,</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unrecognized wave model {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">WaveModel</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>


    <span class="c1"># after all freq have been processed</span>
    <span class="p">(</span><span class="n">BIC_N</span><span class="p">,</span> <span class="n">sigma2_ML</span><span class="p">)</span> <span class="o">=</span> <span class="n">fitNoise</span><span class="p">(</span><span class="n">Sm_bw</span> <span class="o">-</span> <span class="n">Sm_fw_all</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">addNoise</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">WindowId</span><span class="p">,</span> <span class="n">sigma2_ML</span><span class="p">)</span>
    
    <span class="c1"># TODO after estimating noise again, do we want to iterate once more on wave params  ?  </span>
        
    <span class="k">return</span></div>

<div class="viewcode-block" id="bwMessages"><a class="viewcode-back" href="../code.html#EstimationRoutines.bwMessages">[docs]</a><span class="k">def</span> <span class="nf">bwMessages</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Ts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute sufficient statistics, assuming unitary variance</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : 2d float array</span>
<span class="sd">        It is an array of size (K, L). Each column contains the signal at the l-th location.</span>
<span class="sd">    Ts : float</span>
<span class="sd">        The sampling time in [s]</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sm_bw : float array</span>
<span class="sd">        It is an array of size (2, L). Each column refers to the the signal at the l-th location.</span>
<span class="sd">	Contains the mean vector of the message S.</span>
<span class="sd">    Sw_bw : float array</span>
<span class="sd">        It is an array of size (2, 2, L). Each page refers to the the signal at the l-th location.</span>
<span class="sd">	Contains the precision matrix of the message S.</span>
<span class="sd">    Swm_bw : float array</span>
<span class="sd">        It is an array of size (2, L). Each column refers to the the signal at the l-th location.</span>
<span class="sd">	Contains the weighted mean vector of the message S.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">K</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#Fvec = fft.fftfreq(K, Ts);</span>
    <span class="c1">#Fmin=0</span>
    <span class="c1">#Fmax=0.5/Ts</span>
    <span class="c1">#Fndx = (Fvec &gt;= Fmin) and (Fvec &lt;= Fmax);</span>
    <span class="c1">#Fvec=Fvec[Fndx];</span>
    <span class="n">Fnum</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1"># TODO need to make sure K is even</span>
    
    <span class="n">Y_bw</span><span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">Swm_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">Fnum</span><span class="p">));</span>
    <span class="n">Sm_bw</span><span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">Fnum</span><span class="p">));</span>
    <span class="n">Sw_bw</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">Fnum</span><span class="p">));</span>

    <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Fnum</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
            <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">Y_bw</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span><span class="n">ll</span><span class="p">]);</span>
            <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">Y_bw</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span><span class="n">ll</span><span class="p">]);</span>
            <span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
            <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">],</span> <span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]);</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">)</span></div>

<span class="c1">### Vertical wave</span>

<div class="viewcode-block" id="negLL_VerticalWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.negLL_VerticalWave">[docs]</a><span class="k">def</span> <span class="nf">negLL_VerticalWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the loglikelihood of a plane wave (vertical component only)</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (2,N). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes.</span>

<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw :</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    negLogLikelihood : float array</span>
<span class="sd">        A one dimensional array of N elements with the value of minus the log-likelihood.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># single point</span>
        <span class="n">X_grid</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="n">N_points</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Wavenumber_x</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">Wavenumber_y</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>

    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">negLogLikelihood</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="c1"># TODO check if input matrices are const*identity</span>
        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N_points</span><span class="p">):</span>
            <span class="n">Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">:</span>
                    <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
                    <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
                    
                <span class="n">Uw</span> <span class="o">=</span> <span class="n">Uw</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span>
                <span class="n">Uwm</span> <span class="o">=</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>
        <span class="n">Um</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Uw</span><span class="p">,</span> <span class="n">Uwm</span><span class="p">)</span>
        <span class="n">negLogLikelihood</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Um</span><span class="p">)</span> <span class="o">*</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="n">SlnGamma_bw</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>    <span class="c1"># alternative, faster implementation. Requires Sw_bw to be const*Identity</span>
        <span class="n">ndx_v</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">]</span>
        <span class="n">L_v</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_v</span><span class="p">)</span> <span class="c1"># number of vertical components</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,</span> <span class="n">L_v</span><span class="p">))</span>
        <span class="n">Uw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">))</span>
        <span class="n">Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">N_points</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ll_v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_v</span><span class="p">):</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_v</span><span class="p">[</span><span class="n">ll_v</span><span class="p">]</span>
            <span class="n">phi</span><span class="p">[:,</span><span class="n">ll_v</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">Uw</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Uw</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[:,</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[:,</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[:,</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[:,</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Um</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">N_points</span><span class="p">))</span>
        <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">Uw</span><span class="p">[:]</span>
        <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">Uw</span><span class="p">[:]</span>
        <span class="n">negLogLikelihood</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">)</span></div>


<div class="viewcode-block" id="grad_negLL_VerticalWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.grad_negLL_VerticalWave">[docs]</a><span class="k">def</span> <span class="nf">grad_negLL_VerticalWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the gradient of the loglikelihood of a plane wave (vertical component only)</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (2,N). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes.</span>

<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw :</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    grad : float array</span>
<span class="sd">        The gradient.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
        
    
    <span class="n">Wavenumber_x</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="c1"># TODO check if input matrices are const*identity</span>


        <span class="c1"># derivative wrt Wavenumber_x</span>
        <span class="n">Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">dWx_Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">dWx_Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">dWy_Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">dWy_Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">:</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
                <span class="n">dWx_H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
                <span class="n">dWy_H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
                <span class="n">dWx_H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
                <span class="n">dWy_H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
                
            <span class="n">Uw</span> <span class="o">=</span> <span class="n">Uw</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span>
            <span class="n">Uwm</span> <span class="o">=</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>

            <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">dWx_H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">dWx_H</span>
            <span class="n">dWx_Uwm</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">dWx_H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>
            
            <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">dWy_H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">dWy_H</span>
            <span class="n">dWy_Uwm</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">dWy_H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>

        <span class="n">Um</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Uw</span><span class="p">,</span> <span class="n">Uwm</span><span class="p">)</span>
        <span class="n">Uv</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Uw</span><span class="p">)</span>
                
        <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="n">Uv</span><span class="o">*</span><span class="n">dWx_Uw</span><span class="o">*</span><span class="n">Um</span> <span class="o">+</span> <span class="n">Uv</span><span class="o">*</span><span class="n">dWx_Uwm</span> <span class="p">)</span><span class="o">*</span> <span class="n">Uwm</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Um</span><span class="p">)</span><span class="o">*</span><span class="n">dWx_Uwm</span>
        <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="n">Uv</span><span class="o">*</span><span class="n">dWy_Uw</span><span class="o">*</span><span class="n">Um</span> <span class="o">+</span> <span class="n">Uv</span><span class="o">*</span><span class="n">dWy_Uwm</span> <span class="p">)</span><span class="o">*</span> <span class="n">Uwm</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Um</span><span class="p">)</span><span class="o">*</span><span class="n">dWy_Uwm</span>
        
                
    <span class="k">else</span><span class="p">:</span>    <span class="c1"># alternative, faster implementation. Requires Sw_bw to be const*Identity</span>
        <span class="n">ndx_v</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">]</span>
        <span class="n">L_v</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_v</span><span class="p">)</span> <span class="c1"># number of vertical components</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">L_v</span><span class="p">,))</span>
        <span class="n">Uw</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># scalar variance</span>
        <span class="n">Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
        <span class="n">dWx_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
        <span class="n">dWy_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">ll_v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_v</span><span class="p">):</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_v</span><span class="p">[</span><span class="n">ll_v</span><span class="p">]</span>
            <span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">Uw</span> <span class="o">=</span> <span class="n">Uw</span> <span class="o">+</span> <span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">])</span><span class="o">*-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">])</span><span class="o">*-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">])</span><span class="o">*-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
            <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">ll_v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">])</span><span class="o">*-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Um</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
        <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Uw</span>
        <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Uw</span>
        
        <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        
    <span class="k">return</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">fwMessages_VerticalWave</span><span class="p">(</span><span class="n">X_ML</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">ArrayInfo</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">))</span>
    
    <span class="n">Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
    
    <span class="c1"># compute the LL</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span>
        
        <span class="n">Uwm</span> <span class="o">+=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>
    <span class="n">Um</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Uw</span><span class="p">,</span> <span class="n">Uwm</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Um</span><span class="p">)</span> <span class="o">*</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># compute the forward messages Sm_fw</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">Um</span>
        <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">Amplitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Phase</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Sm_fw</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">LL</span><span class="p">)</span>

 
<span class="k">def</span> <span class="nf">fitVerticalWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">):</span>
    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">))</span>
    <span class="n">X_grid</span><span class="o">=</span> <span class="n">X_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># can have grid or single point as input</span>
    
    <span class="n">MaxIterations</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">hist_LL</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">MaxIterations</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">MaxIterations</span><span class="p">):</span>
    
        <span class="p">(</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">)</span> <span class="o">=</span> <span class="n">estimateNoise</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">)</span>
    
        <span class="n">Snw_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">));</span> <span class="n">Snwm_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">));</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
            <span class="n">Snw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">/</span> <span class="n">sigma2</span><span class="p">[</span><span class="n">ll</span><span class="p">];</span>
            <span class="n">Snwm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span> <span class="n">Snw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">ll</span><span class="p">]</span> <span class="p">,</span> <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">Snwm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span> <span class="n">Snw_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="n">ll</span><span class="p">]</span> <span class="p">,</span> <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ML estimate with grid search</span>
            <span class="p">(</span><span class="n">LL</span><span class="p">)</span> <span class="o">=</span> <span class="n">negLL_VerticalWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">)</span>
            
            <span class="n">ndx_min</span> <span class="o">=</span> <span class="n">argmin</span><span class="p">(</span><span class="n">LL</span><span class="p">)</span>
            <span class="n">X_g</span> <span class="o">=</span> <span class="n">X_grid</span><span class="p">[:,</span><span class="n">ndx_min</span><span class="p">];</span>
            

<span class="c1">#            if shape(X_grid)[1] &gt; 3:</span>
<span class="c1">#                plt.ion()</span>
<span class="c1">#                fig = plt.figure()</span>
<span class="c1">#                ax = fig.gca(projection=&#39;3d&#39;)</span>
<span class="c1">#                ax.plot_trisurf(X_grid[0], X_grid[1], -LL, cmap=cm.jet, linewidth=0.2)</span>
<span class="c1">#                plt.title(&quot;log likelihood &quot; + str(ff) + &quot;Hz&quot;)</span>
<span class="c1">#                plt.show()</span>

        <span class="c1"># Refine ML estimate</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">negLL_VerticalWave</span><span class="p">,</span> <span class="n">X_g</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="n">grad_negLL_VerticalWave</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;TNC&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">),(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">)])</span>
        
        
        
        <span class="n">X_ML</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">;</span> <span class="n">LL_ML</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        
        <span class="c1"># Compute fw messages</span>
        <span class="p">(</span><span class="n">Sm_fw_ff</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">LL_ML</span><span class="p">)</span> <span class="o">=</span> <span class="n">fwMessages_VerticalWave</span><span class="p">(</span><span class="n">X_ML</span><span class="p">,</span> <span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">)</span>
        <span class="n">Sm_fw</span><span class="p">[:,:,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_ff</span>
        
        <span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">LL_ML</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">):</span>
            <span class="k">break</span>
        
        
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    
    <span class="n">LogLikelihood</span> <span class="o">=</span> <span class="n">LL_ML</span>
    <span class="n">NumParameters</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">4</span>
    <span class="n">NumPoints</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">BIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span> <span class="n">LogLikelihood</span> <span class="o">+</span> <span class="n">Gamma</span> <span class="o">*</span><span class="n">NumParameters</span> <span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">NumPoints</span><span class="p">)</span>

    
    
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Vertical wave fit&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">LL: {0:.3e} BIC: {1:.3e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LogLikelihood</span><span class="p">,</span> <span class="n">BIC</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Amplitude: {0:.3f}, Phase: {1:.3f}, Wavenumber: {2:.3f}, Azimuth: {3:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Amplitude</span><span class="p">,</span><span class="n">Phase</span><span class="p">,</span><span class="n">Wavenumber</span><span class="p">,</span><span class="n">Azimuth</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">BIC</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">X_ML</span><span class="p">)</span>
    
<span class="c1">### Love wave</span>

<div class="viewcode-block" id="negLL_LoveWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.negLL_LoveWave">[docs]</a><span class="k">def</span> <span class="nf">negLL_LoveWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the likelihood of a Love wave</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (2,N). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes.</span>

<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw : float array</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    negLogLikelihood : float array</span>
<span class="sd">        A one dimensional array of N elements with the value of minus the log-likelihood.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># single point</span>
        <span class="n">X_grid</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="n">N_points</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Wavenumber_x</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>    <span class="c1"># wavenumber is measured in [rad / m]</span>
    <span class="n">Wavenumber_y</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

<span class="c1">#</span>
<span class="c1">#    print(Wavenumber_x)    </span>
<span class="c1">#    print(Wavenumber_y)       </span>
<span class="c1">#    print(Azimuth)</span>
<span class="c1">#    print(Wavenumber)</span>

    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">negLogLikelihood</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    

    <span class="c1"># EWX</span>
    <span class="n">ndx_e</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">]</span>
    <span class="n">L_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_e</span><span class="p">)</span> <span class="c1"># number of EWX components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    <span class="n">Uw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">N_points</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ll_e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_e</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_e</span><span class="p">[</span><span class="n">ll_e</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">Uw</span><span class="p">[:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span><span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span><span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="c1"># NSY</span>
    <span class="n">ndx_n</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">]</span>
    <span class="n">L_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_n</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">ll_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_n</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_n</span><span class="p">[</span><span class="n">ll_n</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">Uw</span><span class="p">[:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span><span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span><span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>

    
    <span class="c1"># ROTZ</span>
    <span class="n">ndx_z</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">ROTZ</span><span class="p">]</span>
    <span class="n">L_z</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_z</span><span class="p">)</span> <span class="c1"># number of ROTZ components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">ll_z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_z</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_z</span><span class="p">[</span><span class="n">ll_z</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">-</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">Uw</span><span class="p">[:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span><span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span><span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="n">Um</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">N_points</span><span class="p">))</span>
    

    
<span class="c1">#        print(Uw)</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">Uw</span><span class="p">[:]</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">Uw</span><span class="p">[:]</span>
    <span class="n">negLogLikelihood</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="grad_negLL_LoveWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.grad_negLL_LoveWave">[docs]</a><span class="k">def</span> <span class="nf">grad_negLL_LoveWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the gradient of the loglikelihood of a Love wave</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (2,1). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes.</span>

<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw : float array</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    grad : float array</span>
<span class="sd">        The gradient of the loglikelihood.</span>
<span class="sd">&quot;&quot;&quot;</span>

    
       
    <span class="n">Wavenumber_x</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># wavenumber is measured in [rad / m]</span>
    <span class="n">Wavenumber_y</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span> <span class="c1"># Note the role reversal</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">Wavenumber_x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Wavenumber_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># singularity, Azimuth is not defined here</span>
        <span class="k">return</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
        
    

    <span class="n">Uw</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># scalar variance</span>
    <span class="n">dWx_Uw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dWy_Uw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">dWx_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">dWy_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>

    <span class="c1"># EWX</span>
    <span class="n">ndx_e</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">]</span>
    <span class="n">L_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_e</span><span class="p">)</span> <span class="c1"># number of EWX components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="o">-</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># TODO here there may be a problem with division by zero            </span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="n">Wavenumber_x</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ll_e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_e</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_e</span><span class="p">[</span><span class="n">ll_e</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
    
    <span class="c1"># NSY</span>
    <span class="n">ndx_n</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">]</span>
    <span class="n">L_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_n</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="o">-</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="n">Wavenumber_x</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ll_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_n</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_n</span><span class="p">[</span><span class="n">ll_n</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>            
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>

    <span class="c1"># ROTZ</span>
    <span class="n">ndx_z</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">ROTZ</span><span class="p">]</span>
    <span class="n">L_z</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_z</span><span class="p">)</span> <span class="c1"># number of ROTZ components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber_x</span><span class="o">/</span><span class="n">Wavenumber</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="n">Wavenumber</span>
    <span class="k">for</span> <span class="n">ll_z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_z</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_z</span><span class="p">[</span><span class="n">ll_z</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">-</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
  
    
    <span class="n">Um</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Uw</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Uw</span>
    
    
    <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dWx_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span><span class="n">dWx_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dWy_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span><span class="n">dWy_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>      </div>
        
<div class="viewcode-block" id="fwMessages_LoveWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.fwMessages_LoveWave">[docs]</a><span class="k">def</span> <span class="nf">fwMessages_LoveWave</span><span class="p">(</span><span class="n">X_ML</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the estimated wavefield of a Love wave.</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_ML : float array</span>
<span class="sd">        Array of size (2,1). The Maximum Likelihood estimate of the wave parameters.</span>
<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw : float array</span>
<span class="sd">        sufficient statistics</span>
<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Sm_fw : float array</span>
<span class="sd">        Wavefield</span>
<span class="sd">    Amplitude : float</span>
<span class="sd">        Wave amplitude</span>
<span class="sd">    Phase : float</span>
<span class="sd">        Wave phase</span>
<span class="sd">    LL : float</span>
<span class="sd">        Model loglikelihood</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    
    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">ArrayInfo</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>

    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">))</span>
    
    <span class="n">Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>    <span class="c1"># compute the LL</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROTZ</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        
        <span class="n">Uw</span> <span class="o">=</span> <span class="n">Uw</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span>
        
        <span class="n">Uwm</span> <span class="o">=</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>
    <span class="n">Um</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Uw</span><span class="p">,</span> <span class="n">Uwm</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Um</span><span class="p">)</span> <span class="o">*</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>    <span class="c1"># compute the LL</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROTZ</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">Um</span>
        <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">Amplitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Phase</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Sm_fw</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">LL</span><span class="p">)</span></div>

 
<div class="viewcode-block" id="fitLoveWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.fitLoveWave">[docs]</a><span class="k">def</span> <span class="nf">fitLoveWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Finds the maximum likelihood fit a monochromatic Love wave</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (2,N). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes.</span>

<span class="sd">    Sw_bw, Swm_bw : float array</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ff : int</span>
<span class="sd">        index of the frequency of interest</span>

<span class="sd">    L : int</span>
<span class="sd">        Number of channels</span>

<span class="sd">    K : int</span>
<span class="sd">        number of samples</span>

<span class="sd">    Kmax : float</span>
<span class="sd">        Largest wavenumber [1/m] to analyze</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    BIC : float</span>
<span class="sd">        Value of the Bayesian information criterion</span>
<span class="sd">    Sm_fw : float array</span>
<span class="sd">        Wavefield generated by the estimated wave</span>
<span class="sd">    Amplitude : float</span>
<span class="sd">        Wave amplitude</span>
<span class="sd">    Phase : float</span>
<span class="sd">        Wave phase</span>
<span class="sd">    X_ML : float array</span>
<span class="sd">        Array of size (2,1). The Maximum Likelihood estimate of the wave parameters.</span>

<span class="sd">&quot;&quot;&quot;</span>
    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">))</span>
    <span class="n">X_grid</span><span class="o">=</span> <span class="n">X_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># can have grid or single point as input</span>
    
    <span class="n">MaxIterations</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">hist_LL</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">MaxIterations</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">MaxIterations</span><span class="p">):</span>
    
        <span class="p">(</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">)</span> <span class="o">=</span> <span class="n">estimateNoise</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">)</span>
    
        <span class="n">Snw_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">));</span> <span class="n">Snwm_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">));</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
            <span class="n">Snw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">/</span> <span class="n">sigma2</span><span class="p">[</span><span class="n">ll</span><span class="p">];</span>
            <span class="n">Snwm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span> <span class="n">Snw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">ll</span><span class="p">]</span> <span class="p">,</span> <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">Snwm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span> <span class="n">Snw_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="n">ll</span><span class="p">]</span> <span class="p">,</span> <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ML estimate with grid search</span>
            <span class="p">(</span><span class="n">LL</span><span class="p">)</span> <span class="o">=</span> <span class="n">negLL_LoveWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">)</span>
            
            <span class="n">ndx_min</span> <span class="o">=</span> <span class="n">argmin</span><span class="p">(</span><span class="n">LL</span><span class="p">)</span>
            <span class="n">X_g</span> <span class="o">=</span> <span class="n">X_grid</span><span class="p">[:,</span><span class="n">ndx_min</span><span class="p">];</span>

            <span class="c1">### test gradient</span>
            <span class="c1">#print(&quot;Love wave likelihood: testing gradient&quot;)</span>
            <span class="c1">#print(X_grid[:,0])</span>
            <span class="c1">#grad1 = approx_fprime(X_grid[:,0], negLL_LoveWave, sqrt(np.finfo(float).eps), Snw_bw, Snwm_bw, SlnGamma_bw, ArrayInfo)</span>
            <span class="c1">#print(grad1)</span>
            <span class="c1">#grad2 = grad_negLL_LoveWave(X_grid[:,0], Snw_bw, Snwm_bw, SlnGamma_bw, ArrayInfo)</span>
            <span class="c1">#print(grad2)</span>
            <span class="c1">#</span>
            <span class="c1">#if shape(X_grid)[1] &gt; 3:</span>
            <span class="c1">#    from mpl_toolkits.mplot3d import Axes3D # this line is needed for projection=&#39;3d&#39;</span>
            <span class="c1">#    from matplotlib import cm</span>
            <span class="c1">#    import matplotlib.pyplot as plt</span>
            <span class="c1">#    plt.ion()</span>
            <span class="c1">#    fig = plt.figure()</span>
            <span class="c1">#    ax = fig.gca(projection=&#39;3d&#39;)</span>
            <span class="c1">#    ax.view_init(90, 270)</span>
            <span class="c1">#    ax.plot_trisurf(X_grid[0], X_grid[1], -LL, cmap=cm.jet, linewidth=0.0)</span>
            <span class="c1">#    plt.title(&quot;Love wave log likelihood - &quot; + str(ff))</span>
            <span class="c1">#    plt.show()</span>
            <span class="c1">#    plt.pause(5)</span>
                

        <span class="c1"># Refine ML estimate</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">negLL_LoveWave</span><span class="p">,</span> <span class="n">X_g</span><span class="p">,</span> <span class="p">(</span><span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">),</span><span class="s1">&#39;TNC&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">),(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">)],</span> <span class="n">jac</span><span class="o">=</span><span class="n">grad_negLL_LoveWave</span><span class="p">)</span>
        <span class="n">X_ML</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">;</span> <span class="n">LL_ML</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        
        
        <span class="c1">#Kx = X_ML[0]</span>
        <span class="c1">#Ky = X_ML[1]</span>
        <span class="c1">#Wavenumber = sqrt( Kx**2 + Ky**2)</span>
        <span class="c1">#Azimuth = np.mod(arctan2(Ky, Kx), 2*pi)</span>
        <span class="c1">#print(&quot;Love wave ML estimate: {:.2e} {:.2e}&quot;.format(Wavenumber, Azimuth))</span>

        
        <span class="c1"># Compute fw messages</span>
        <span class="p">(</span><span class="n">Sm_fw_ff</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">LL_ML</span><span class="p">)</span> <span class="o">=</span> <span class="n">fwMessages_LoveWave</span><span class="p">(</span><span class="n">X_ML</span><span class="p">,</span> <span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">)</span>
        <span class="n">Sm_fw</span><span class="p">[:,:,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_ff</span>
        
        <span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">LL_ML</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">):</span>
            <span class="k">break</span>
        
        
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    
    <span class="n">LogLikelihood</span> <span class="o">=</span> <span class="n">LL_ML</span>
    <span class="n">NumParameters</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">4</span>
    <span class="n">NumPoints</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">BIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span> <span class="n">LogLikelihood</span> <span class="o">+</span> <span class="n">Gamma</span> <span class="o">*</span><span class="n">NumParameters</span> <span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">NumPoints</span><span class="p">)</span>

    
    
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Love wave fit&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">LL: {0:.3e} BIC: {1:.3e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LogLikelihood</span><span class="p">,</span> <span class="n">BIC</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Amplitude: {0:.3f}, Phase: {1:.3f}, Wavenumber: {2:.3f}, Azimuth: {3:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Amplitude</span><span class="p">,</span><span class="n">Phase</span><span class="p">,</span><span class="n">Wavenumber</span><span class="p">,</span><span class="n">Azimuth</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">BIC</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">X_ML</span><span class="p">)</span></div>


<span class="c1">### Rayleigh wave</span>

<div class="viewcode-block" id="negLL_RayleighWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.negLL_RayleighWave">[docs]</a><span class="k">def</span> <span class="nf">negLL_RayleighWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the loglikelihood of a Rayleigh wave</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (3,N). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes. Third row the ellipticity angle.</span>

<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw : float array</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    negLogLikelihood : float array</span>
<span class="sd">        A one dimensional array of N elements with the value of minus the log-likelihood.</span>
<span class="sd">&quot;&quot;&quot;</span>

    
    <span class="k">if</span> <span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># single point</span>
        <span class="n">X_grid</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="n">N_points</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">X_grid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Wavenumber_x</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>    <span class="c1"># wavenumber is measured in [rad / m]</span>
    <span class="n">Wavenumber_y</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="n">EllipticityAngle</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">negLogLikelihood</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,))</span>
    
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="n">Uw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">))</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">N_points</span><span class="p">))</span>

    <span class="c1"># EWX</span>
    <span class="n">ndx_e</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">]</span>
    <span class="n">L_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_e</span><span class="p">)</span> <span class="c1"># number of EWX components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">ll_e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_e</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_e</span><span class="p">[</span><span class="n">ll_e</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="c1"># NSY</span>
    <span class="n">ndx_n</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">]</span>
    <span class="n">L_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_n</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">ll_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_n</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_n</span><span class="p">[</span><span class="n">ll_n</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">Uw</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
    <span class="c1"># UDZ</span>
    <span class="n">ndx_z</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">]</span>
    <span class="n">L_z</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_z</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">ll_z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_z</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_z</span><span class="p">[</span><span class="n">ll_z</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">+</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>

    <span class="c1"># ROTX</span>
    <span class="n">ndx_x</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">ROTX</span><span class="p">]</span>
    <span class="n">L_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_x</span><span class="p">)</span> <span class="c1"># number of ROTX components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">ll_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_x</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_x</span><span class="p">[</span><span class="n">ll_x</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>

    <span class="c1"># ROTY</span>
    <span class="n">ndx_y</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">ROTY</span><span class="p">]</span>
    <span class="n">L_y</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_y</span><span class="p">)</span> <span class="c1"># number of ROTY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">N_points</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">ll_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_y</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_y</span><span class="p">[</span><span class="n">ll_y</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="p">[:]</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">Uw</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="n">Um</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">N_points</span><span class="p">))</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">Uw</span><span class="p">[:]</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">/</span> <span class="n">Uw</span><span class="p">[:]</span>
    <span class="n">negLogLikelihood</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">)</span></div>
 

 
<div class="viewcode-block" id="grad_negLL_RayleighWave"><a class="viewcode-back" href="../code.html#EstimationRoutines.grad_negLL_RayleighWave">[docs]</a><span class="k">def</span> <span class="nf">grad_negLL_RayleighWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the gradient of the loglikelihood of a Rayleigh wave</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_grid : float array</span>
<span class="sd">        Array of size (3,1). Description of N points to evaluate likelihoodfunction. First row is the wavenumber along the x axes. Second row the wavenumber along the y axes. Third row the ellipticity angle.</span>

<span class="sd">    Sw_bw, Swm_bw, SlnGamma_bw : float array</span>
<span class="sd">        sufficient statistics</span>

<span class="sd">    ArrayInfo : float array</span>
<span class="sd">        An array containing information about sensor location and channels.</span>
<span class="sd">        It has L rows, where L is the number of channels.</span>
<span class="sd">        Each rows has the following form:</span>
<span class="sd">          pos_x, pos_y, pos_z, cmp, Ts</span>
<span class="sd">        where the first three fields are the position of the sensor in [m].</span>
<span class="sd">        cmp is the component code.</span>
<span class="sd">        Ts is the sampling time as read from the SAC file.</span>
<span class="sd"> </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    grad : float array</span>
<span class="sd">        The gradient of the loglikelihood.</span>
<span class="sd">&quot;&quot;&quot;</span>

    
    <span class="n">Wavenumber_x</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># wavenumber is measured in [rad / m]</span>
    <span class="n">Wavenumber_y</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">EllipticityAngle</span><span class="o">=</span><span class="n">X_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span> <span class="c1"># Note the role reversal</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">grad</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">Wavenumber_x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Wavenumber_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># singularity, Azimuth is not defined here</span>
        <span class="k">return</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    
    <span class="n">Uw</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># scalar variance</span>
    <span class="n">dWx_Uw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dWy_Uw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dEl_Uw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">dWx_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">dWy_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">dEl_Uwm</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>

    <span class="c1"># EWX</span>
    <span class="n">ndx_e</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">]</span>
    <span class="n">L_e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_e</span><span class="p">)</span> <span class="c1"># number of EWX components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="o">-</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="n">Wavenumber_x</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dEl_alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">dEl_phi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ll_e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_e</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_e</span><span class="p">[</span><span class="n">ll_e</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dEl_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dEl_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
    
    <span class="c1"># NSY</span>
    <span class="n">ndx_n</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">]</span>
    <span class="n">L_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_n</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="o">-</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span> <span class="n">Wavenumber_x</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dEl_alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
    <span class="n">dEl_phi</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">ll_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_n</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_n</span><span class="p">[</span><span class="n">ll_n</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>            
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dEl_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dEl_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        
    <span class="c1"># UDZ</span>
    <span class="n">ndx_z</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">]</span>
    <span class="n">L_z</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_z</span><span class="p">)</span> <span class="c1"># number of UDZ components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dEl_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">dEl_phi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ll_z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_z</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_z</span><span class="p">[</span><span class="n">ll_z</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">+</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dEl_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dEl_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>

    <span class="c1"># ROTX</span>
    <span class="n">ndx_x</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">ROTX</span><span class="p">]</span>
    <span class="n">L_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_x</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">Wavenumber_x</span><span class="o">/</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">+</span> <span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*-</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">Wavenumber_y</span><span class="o">/</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">+</span> <span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">Wavenumber_x</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">dEl_alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*-</span><span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">dEl_phi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ll_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_x</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_x</span><span class="p">[</span><span class="n">ll_x</span><span class="p">]</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dEl_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dEl_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>

    <span class="c1"># ROTY</span>
    <span class="n">ndx_y</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="n">comp</span> <span class="o">==</span> <span class="n">ROTY</span><span class="p">]</span>
    <span class="n">L_y</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndx_y</span><span class="p">)</span> <span class="c1"># number of NSY components</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">dWx_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">Wavenumber_x</span><span class="o">/</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">+</span> <span class="n">Wavenumber</span><span class="o">*-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*-</span><span class="n">Wavenumber_y</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">dWy_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">Wavenumber_y</span><span class="o">/</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">+</span> <span class="n">Wavenumber</span><span class="o">*-</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">Wavenumber_x</span><span class="o">/</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">dEl_alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*-</span><span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
    <span class="n">dEl_phi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ll_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_y</span><span class="p">):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="n">ndx_y</span><span class="p">[</span><span class="n">ll_y</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
        <span class="n">cosPhi</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sinPhi</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">dWx_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>
        
        <span class="n">Uw</span> <span class="o">+=</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWx_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWx_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dWy_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dWy_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dEl_alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">cosPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">-</span> <span class="n">sinPhi</span> <span class="o">*</span> <span class="n">Swm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">dEl_phi</span>
        <span class="n">dWx_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWx_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dWy_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dWy_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
        <span class="n">dEl_Uw</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">dEl_alpha</span><span class="o">*</span><span class="n">Sw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span>
    
    <span class="n">Um</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">Uw</span>
    <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Uw</span>
    
    
    <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dWx_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span><span class="n">dWx_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dWx_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dWy_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span><span class="n">dWy_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dWy_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">grad</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dEl_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span><span class="n">dEl_Uw</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dEl_Uwm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span></div>
        
<span class="k">def</span> <span class="nf">fwMessages_RayleighWave</span><span class="p">(</span><span class="n">X_ML</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">Swm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">):</span>
    
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">EllipticityAngle</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    
    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">ArrayInfo</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_x</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comp</span><span class="o">=</span><span class="n">ArrayInfo</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">))</span>
    
    <span class="n">Uw</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">Uwm</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>    <span class="c1"># compute the LL</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">+</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROTX</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROTY</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        
        <span class="n">Uw</span> <span class="o">=</span> <span class="n">Uw</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">])</span> <span class="o">*</span> <span class="n">H</span>
        
        <span class="n">Uwm</span> <span class="o">=</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="n">transpose</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="n">transpose</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">Swm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">]))</span>
    <span class="n">Um</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Uw</span><span class="p">,</span> <span class="n">Uwm</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">transpose</span><span class="p">(</span><span class="n">Um</span><span class="p">)</span> <span class="o">*</span> <span class="n">Uwm</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="n">LL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>    <span class="c1"># compute the forward messages Sm_fw</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">EWX</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">NSY</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">UDZ</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">+</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROTX</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">elif</span>  <span class="n">comp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROTY</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">*</span><span class="n">pos_x</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">*</span><span class="n">pos_y</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">Wavenumber</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">Azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">EllipticityAngle</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)],[</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">Um</span>
        <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">Amplitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Phase</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Um</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Um</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">Sm_fw</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">LL</span><span class="p">)</span>

 
<span class="k">def</span> <span class="nf">fitRayleighWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sw_bw</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">):</span>
    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">))</span>
    <span class="n">X_grid</span><span class="o">=</span> <span class="n">X_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># can have grid or single point as input</span>
    
    <span class="n">MaxIterations</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">hist_LL</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">MaxIterations</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">MaxIterations</span><span class="p">):</span>
    
        <span class="p">(</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">)</span> <span class="o">=</span> <span class="n">estimateNoise</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">)</span>
    
        <span class="n">Snw_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">));</span> <span class="n">Snwm_bw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="p">));</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
            <span class="n">Snw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sw_bw</span><span class="p">[:,:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="o">/</span> <span class="n">sigma2</span><span class="p">[</span><span class="n">ll</span><span class="p">];</span>
            <span class="n">Snwm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span> <span class="n">Snw_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">ll</span><span class="p">]</span> <span class="p">,</span> <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">Snwm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span> <span class="n">Snw_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="n">ll</span><span class="p">]</span> <span class="p">,</span> <span class="n">Sm_bw</span><span class="p">[:,</span><span class="n">ll</span><span class="p">,</span><span class="n">ff</span><span class="p">]</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ML estimate with grid search</span>
            <span class="p">(</span><span class="n">LL</span><span class="p">)</span> <span class="o">=</span> <span class="n">negLL_RayleighWave</span><span class="p">(</span><span class="n">X_grid</span><span class="p">,</span> <span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">)</span>
            
            <span class="n">ndx_min</span> <span class="o">=</span> <span class="n">argmin</span><span class="p">(</span><span class="n">LL</span><span class="p">)</span>
            <span class="n">X_g</span> <span class="o">=</span> <span class="n">X_grid</span><span class="p">[:,</span><span class="n">ndx_min</span><span class="p">];</span>
            

            <span class="c1">### test gradient</span>
            <span class="c1">#print(&quot;Rayleigh wave likelihood: testing gradient&quot;)</span>
            <span class="c1">#print(X_grid[:,0])</span>
            <span class="c1">#grad1 = approx_fprime(X_grid[:,0], negLL_RayleighWave, sqrt(np.finfo(float).eps), Snw_bw, Snwm_bw, SlnGamma_bw, ArrayInfo)</span>
            <span class="c1">#print(grad1)</span>
            <span class="c1">#grad2 = grad_negLL_RayleighWave(X_grid[:,0], Snw_bw, Snwm_bw, SlnGamma_bw, ArrayInfo)</span>
            <span class="c1">#print(grad2)</span>

            <span class="c1">#</span>
            <span class="c1">#if shape(X_grid)[1] &gt; 3:</span>
            <span class="c1">#    from mpl_toolkits.mplot3d import Axes3D # this line is needed for projection=&#39;3d&#39;</span>
            <span class="c1">#    from matplotlib import cm</span>
            <span class="c1">#    import matplotlib.pyplot as plt</span>
            <span class="c1">#    plt.ion()</span>
            <span class="c1">#    fig = plt.figure()</span>
            <span class="c1">#    ax = fig.gca(projection=&#39;3d&#39;)</span>
            <span class="c1">#    ax.view_init(90, 270)</span>
            <span class="c1">#    ax.plot_trisurf(X_grid[0], X_grid[1], -LL, cmap=cm.jet, linewidth=0.0)</span>
            <span class="c1">#    plt.title(&quot;Love wave log likelihood - &quot; + str(ff))</span>
            <span class="c1">#    plt.show()</span>
            <span class="c1">#    plt.pause(5)</span>


<span class="c1">#            if shape(X_grid)[1] &gt; 3:</span>
<span class="c1">#                plt.ion()</span>
<span class="c1">#                fig = plt.figure()</span>
<span class="c1">#                ax = fig.gca(projection=&#39;3d&#39;)</span>
<span class="c1">#                ax.plot_trisurf(X_grid[0], X_grid[1], -LL, cmap=cm.jet, linewidth=0.2)</span>
<span class="c1">#                plt.title(&quot;log likelihood &quot; + str(ff) + &quot;Hz&quot;)</span>
<span class="c1">#                plt.show()</span>

        <span class="c1"># Refine ML estimate</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">negLL_RayleighWave</span><span class="p">,</span> <span class="n">X_g</span><span class="p">,</span> <span class="p">(</span><span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">),</span><span class="s1">&#39;TNC&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">),(</span><span class="o">-</span><span class="n">Kmax</span><span class="p">,</span> <span class="n">Kmax</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi</span><span class="p">)],</span> <span class="n">jac</span><span class="o">=</span><span class="n">grad_negLL_RayleighWave</span><span class="p">)</span>
        <span class="c1"># numerical optimization with &#39;L-BFGS-B&#39;, showed some issues. Estimates were clustered around grid search points.</span>
        <span class="n">X_ML</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">;</span> <span class="n">LL_ML</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        
        <span class="c1">#Kx = X_ML[0]</span>
        <span class="c1">#Ky = X_ML[1]</span>
        <span class="c1">#Ellipticity = X_ML[2]</span>
        <span class="c1">#Wavenumber = sqrt( Kx**2 + Ky**2)</span>
        <span class="c1">#Azimuth = np.mod(arctan2(Ky, Kx), 2*pi)</span>
        <span class="c1">#print(&quot;Rayleigh wave ML estimate: {:.2e} {:.2e} {:.2e}&quot;.format(Wavenumber, Azimuth, Ellipticity))</span>

        
        <span class="c1"># Compute fw messages</span>
        <span class="p">(</span><span class="n">Sm_fw_ff</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">LL_ML</span><span class="p">)</span> <span class="o">=</span> <span class="n">fwMessages_RayleighWave</span><span class="p">(</span><span class="n">X_ML</span><span class="p">,</span> <span class="n">Snw_bw</span><span class="p">,</span> <span class="n">Snwm_bw</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">,</span> <span class="n">ArrayInfo</span><span class="p">)</span>
        <span class="n">Sm_fw</span><span class="p">[:,:,</span><span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw_ff</span>
        
        <span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">LL_ML</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">hist_LL</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">):</span>
            <span class="k">break</span>
        
        
    <span class="n">Wavenumber_x</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wavenumber_y</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">EllipticityAngle</span> <span class="o">=</span> <span class="n">X_ML</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Wavenumber</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Wavenumber_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Wavenumber_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Azimuth</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">Wavenumber_y</span><span class="p">,</span> <span class="n">Wavenumber_x</span><span class="p">)</span>
    
    <span class="n">LogLikelihood</span> <span class="o">=</span> <span class="n">LL_ML</span>
    <span class="n">NumParameters</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="n">NumPoints</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">BIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span> <span class="n">LogLikelihood</span> <span class="o">+</span> <span class="n">Gamma</span> <span class="o">*</span><span class="n">NumParameters</span> <span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">NumPoints</span><span class="p">)</span>

    
    
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Rayleigh wave fit&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">LL: {0:.3e} BIC: {1:.3e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LogLikelihood</span><span class="p">,</span> <span class="n">BIC</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Amplitude: {0:.3f}, Phase: {1:.3f}, Wavenumber: {2:.3f}, Azimuth: {3:.3f}, EllipticityAngle: {4:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Amplitude</span><span class="p">,</span><span class="n">Phase</span><span class="p">,</span><span class="n">Wavenumber</span><span class="p">,</span><span class="n">Azimuth</span><span class="p">,</span><span class="n">EllipticityAngle</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">BIC</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">,</span> <span class="n">Amplitude</span><span class="p">,</span> <span class="n">Phase</span><span class="p">,</span> <span class="n">X_ML</span><span class="p">)</span>
    

<span class="c1">### Noise model       </span>
        
<div class="viewcode-block" id="estimateNoise"><a class="viewcode-back" href="../code.html#EstimationRoutines.estimateNoise">[docs]</a><span class="k">def</span> <span class="nf">estimateNoise</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimate noise parameters</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Sm_bw : float array</span>
<span class="sd">        Sufficient statistics from measurements</span>
<span class="sd">    Sm_fw : float array</span>
<span class="sd">        Wavefield explained by modeled waves</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sigma2 : float array</span>
<span class="sd">        Noise variance estimated from residual signal. One dimensional array of length L.</span>
<span class="sd">    SlnGamma_bw : float array</span>
<span class="sd">	Array of gamma scale factors computed with the estimated noise variance</span>
<span class="sd">&quot;&quot;&quot;</span>
    
    <span class="n">L</span><span class="o">=</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">K</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">SlnGamma_bw</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,))</span>
    <span class="n">sigma2</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="n">Y_bw</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,))</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,))</span>
        <span class="n">Y_fw</span><span class="o">=</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,))</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">zeros</span><span class="p">((</span><span class="n">K</span><span class="p">,))</span>

        <span class="n">Kd2p1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Kd2</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Y_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Kd2p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">,:]</span> <span class="o">+</span> <span class="mi">1j</span><span class="o">*</span><span class="n">Sm_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">,:]</span>
        <span class="n">Y_bw</span><span class="p">[</span><span class="n">Kd2p1</span><span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">Y_bw</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Kd2</span><span class="p">])</span>
        <span class="n">Y_fw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Kd2p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sm_fw</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ll</span><span class="p">,:]</span> <span class="o">+</span> <span class="mi">1j</span><span class="o">*</span><span class="n">Sm_fw</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ll</span><span class="p">,:]</span>
        <span class="n">Y_fw</span><span class="p">[</span><span class="n">Kd2p1</span><span class="p">:</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">conjugate</span><span class="p">(</span><span class="n">Y_fw</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Kd2</span><span class="p">])</span>
        
        <span class="n">sigma2</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">real</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Y_bw</span><span class="p">)</span><span class="o">*</span><span class="n">Y_bw</span><span class="p">)</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">real</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Y_bw</span><span class="p">)</span><span class="o">*</span><span class="n">Y_fw</span><span class="p">)</span> <span class="o">+</span> <span class="n">real</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Y_fw</span><span class="p">)</span><span class="o">*</span><span class="n">Y_fw</span><span class="p">))</span> <span class="o">/</span><span class="mi">4</span>
        <span class="c1"># sigma2_b[ll] = sum((y_fw[:,ll] - y_bw[:,ll])**2)/K # time domain</span>
        
        <span class="n">SlnGamma_bw</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">sigma2</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span> <span class="o">-</span><span class="n">K</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">Y_bw</span><span class="p">)</span><span class="o">*</span><span class="n">Y_bw</span><span class="p">))</span><span class="o">/</span><span class="n">sigma2</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span>
    
    <span class="c1">#if EQUAL_SIGMA2:</span>
    <span class="c1">#    sigma2 = np.mean(sigma2)*np.ones((L,))</span>
    <span class="c1">#    SlnGamma_bw = - (K/2)* log(2*pi*sigma2[0])</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="fitNoise"><a class="viewcode-back" href="../code.html#EstimationRoutines.fitNoise">[docs]</a><span class="k">def</span> <span class="nf">fitNoise</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimate noise parameters</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Sm_bw : float array</span>
<span class="sd">        Sufficient statistics from measurements</span>
<span class="sd">    Sm_fw : float array</span>
<span class="sd">        Wavefield explained by modeled waves</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    BIC : float</span>
<span class="sd">        Value of the Bayesian information criterion</span>
<span class="sd">    sigma2_ML : float array</span>
<span class="sd">        Noise variance estimated from residual signal. One dimensional array of length L.</span>
<span class="sd">&quot;&quot;&quot;</span>

    
    <span class="n">Sm_fw</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">))</span>
    
    <span class="p">(</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">SlnGamma_bw</span><span class="p">)</span> <span class="o">=</span> <span class="n">estimateNoise</span><span class="p">(</span><span class="n">Sm_bw</span><span class="p">,</span> <span class="n">Sm_fw</span><span class="p">)</span>
    
    <span class="n">LogLikelihood</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">SlnGamma_bw</span><span class="p">)</span>
    <span class="n">NumParameters</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">NumPoints</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">BIC</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span> <span class="n">LogLikelihood</span> <span class="o">+</span> <span class="n">Gamma</span> <span class="o">*</span><span class="n">NumParameters</span> <span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">NumPoints</span><span class="p">)</span>
    <span class="n">sigma2_ML</span> <span class="o">=</span> <span class="n">sigma2</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Additive Gaussian noise fit&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">LL: {0:.3e} BIC: {1:.3e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LogLikelihood</span><span class="p">,</span> <span class="n">BIC</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">sigma2: {0:.2e} ... {1:.2e} ...  {2:.2e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sigma2</span><span class="p">),</span> <span class="n">mean</span><span class="p">(</span><span class="n">sigma2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">sigma2</span><span class="p">)))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">BIC</span><span class="p">,</span> <span class="n">sigma2_ML</span><span class="p">)</span></div>
    
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
<li><a href="http://mercalli.ethz.ch/~marra/">Home</a> &raquo; <a href="../index.html">WaveDec  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      Last updated on Jul 15, 2017.
    <br>
        &copy; Copyright 2017, Stefano MaranÃ².
<!-- <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"/></a>-->
 This documentation is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ?
"https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost +
"google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-4477781-2");
pageTracker._trackPageview();
} catch(err) {}
</script>
  </body>
</html>