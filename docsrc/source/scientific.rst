=========================
Scientist's Documentation
=========================

WavDec is a software for the analysis of seismic surface waves. Love and Rayleigh waves are analyzed using a maximum likelihood approach. The implementation in WaveDec follows an algorithm described in [Maranò_et_al_2012]_.

.. contents::
   :local:
   :backlinks: top

Signal model
############

The two major types of seismic surface waves are Love and Rayleigh waves.

To measure seismic waves, we deploy an array of triaxial seismometers on the surface of the earth. We restrict our interest to small aperture arrays and work with a flat earth model. We use a three-dimensional, right-handed Cartesian coordinate system with the :math:`z` axis pointing upward. The azimuth :math:`\psi` is measured counter-clockwise from the :math:`x` axis. Each sensor measures the ground velocity along the direction of the axes of the coordinate system :math:`x`, :math:`y`, and :math:`z`. For the sake of simplicity, we provide wave equations of the displacement field :math:`\mathbf{u}`, despite the actual measurement is often the velocity field :math:`\frac{\partial\mathbf{u}}{\partial t}`.
 
We are interested in the analysis of waves propagating near the surface of the earth and having a direction of propagation lying on the horizontal plane :math:`z=0`. We consider the wavefield to be composed of the superposition of several Rayleigh and Love waves. The wave equations we describe hereafter are valid for :math:`z=0` and for plane wave fronts. The direction of propagation of a wave is given by the wave vector :math:`\boldsymbol{\kappa}=\kappa\left(\cos\psi,\sin\psi,0\right)^{T}`, whose magnitude :math:`\kappa=2\pi/\lambda` is the wavenumber and :math:`\lambda` is the wavelength. The phase velocity :math:`v` at frequency :math:`f` if related to the wavenumber as :math:`v=2\pi f/\kappa`.

Love wave
*********

.. _figLoveWave:

.. figure:: images/love_wave.png
  :alt: A Love wave
  :align: right
  :width: 80%
  :figwidth: 20%

  Graphical representation of the displacement induced by a single Love wave.

Love waves exhibit a particle motion confined to the horizontal plane. The particle oscillates perpendicular to the direction of propagation. The particle displacement generated by a single Love wave
at position and time :math:`(\mathbf{p},t)` is

.. math::
   :label: LoveWave
   :nowrap:

   \begin{eqnarray*}
      u_x(\mathbf{p},t) & = & -\alpha \sin \psi \, cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \\
      u_y(\mathbf{p},t) & = & \alpha \cos \psi \, cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \\
      u_z(\mathbf{p},t) & = & 0 \,.
   \end{eqnarray*}


The displacement induced by a single Love wave is depicted in on the right. The wavevector :math:`\boldsymbol{\kappa}` is shown. The motion of a single test particle is also shown.

At a given frequency :math:`\omega`, a Love wave is parametrized by the parameter vector :math:`\boldsymbol{\theta} = (\alpha,\phi,\kappa,\psi)`.

Rotational motions induced by a Love wave are

.. math::
   :label: LoveWaveRotational
   :nowrap:

   \begin{eqnarray*}
      \omega_x(\mathbf{p},t) & = & 0 \\
      \omega_y(\mathbf{p},t) & = & 0 \\
      \omega_z(\mathbf{p},t) & = & \frac{1}{2} \alpha \kappa \sin(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \,.
   \end{eqnarray*}

More details on the analysis of rotational motions are found in [Maranò_et_al_2014]_.

.. _ScientificRayleighWave:

Rayleigh wave
*************

.. _figRayleighWave:

.. figure:: images/rayleigh_wave.png
  :alt: A Rayleigh wave
  :align: right
  :width: 80%
  :figwidth: 20%

  Graphical representation of the displacement induced by a single Rayleigh wave.


Rayleigh waves exhibit an elliptical particle motion confined to
the vertical plane perpendicular to the surface of the earth and
containing the direction of propagation of the wave. The particle
displacement generated by a single Rayleigh wave is

.. math::
   :label: RayleighWave
   :nowrap:

   \begin{eqnarray*}
      u_x(\mathbf{p},t) & = & \alpha \sin \xi \, \cos \psi \, \cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \\
      u_y(\mathbf{p},t) & = & \alpha \sin \xi \, \sin \psi \, \cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \\
      u_z(\mathbf{p},t) & = & \alpha \cos \xi \, \cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} +\pi/2 + \phi) \,.
   \end{eqnarray*}

The displacement induced by a single Rayleigh wave is depicted in on the right. The wavevector :math:`\boldsymbol{\kappa}` is shown. The elliptical and retrograde motion of a single test particle is also shown.

At a given frequency :math:`\omega`, a Rayleigh wave is parametrized by the parameter vector :math:`\boldsymbol{\theta} = (\alpha,\phi,\kappa,\psi,\xi)`.

The angle :math:`\xi\in[-\pi/2;+\pi/2]` is called ellipticity angle of the Rayleigh wave and determines the eccentricity and the sense of rotation of the particle motion. The figure below (a) depicts the particle motion of a Rayleigh wave and how the ellipticity angle is defined. Rayleigh wave particle motion is depicted with a black ellipse and the sense of rotation with the black arrows on the ellipse. The :math:`z` axis is vertical to the surface. The :math:`x` axis lies on the surface and is parallel to the wavevector :math:`\bm{\kappa}`. The ellipticity angle :math:`\xi` has the vertex at the topmost intersection between the :math:`z` axis and the particle motion ellipse. The first side of the ellipticity angle is the :math:`z` axis. The second side is the line connecting the vertex with the intersection of the :math:`x` axes and the particle motion ellipse (the intersection is chosen such that the particle motion at the intersection has a :math:`+\pi/2` radians shift with respect to the vertex).

When :math:`\xi\in\left(-\pi/2,0\right)`, the Rayleigh wave particle motion is said to be retrograde (i.e., the oscillation on the vertical component :math:`(u_{z})` is shifted by :math:`+\pi/2` radians with respect to the oscillation on the direction of propagation). Two possible retrograde particle motions and corresponding ellipticity angles are shown in (c) and (d). When :math:`\xi\in\left(0,\pi/2\right)` the particle motion is said to be prograde, cf. (f) and (g). For :math:`\xi=\pm\pi/2` cf. (b) and :math:`\xi=0` (e) the particle motion polarization is horizontal and vertical, respectively.

.. _figEllipticityRepresentation:

.. figure:: images/EllipticityRepresentation.png
  :alt: Rayleigh wave Ellipticity angle
  :align: center
  :width: 80%
  :figwidth: 80%
  :figclass: align-center

  Depiction of the Rayleigh wave particle motion for several values of the ellipticity angle :math:`\xi\in[-\pi/2;+\pi/2]`.
  Rayleigh wave particle motion is depicted with a black solid line and the sense of rotation with the black arrows. 
  The :math:`z` axes denotes the surface vertical. The :math:`x` axis lies on the surface and is parallel to the wavevector :math:`\bm{\kappa}`.
  (a) The elliptical particle motion for a retrograde Rayleigh wave. The quantities :math:`\alpha`, H, and V are also shown.
  (b) The Rayleigh wave is horizontally polarized for :math:`\xi=\pm\pi/2`. (c) Retrograde particle motion for :math:`\xi=-\pi/6`. (d) Retrograde particle motion for :math:`\xi=-\pi/3`. (e) The Rayleigh wave is vertically polarized for :math:`\xi=0`. (f) Prograde particle motion for :math:`\xi=\pi/6`. (g) Prograde particle motion for :math:`\xi=\pi/3`. :download:`Download image (PDF).<AdditionalFiles/EllipticityRepresentation.pdf>`


Rotational motions induced by a Rayleigh wave are

.. math::
   :label: RayleighWaveRotational
   :nowrap:

   \begin{eqnarray*}
      \omega_x(\mathbf{p},t) & = & \alpha \kappa \sin\psi \cos\xi \cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \\
      \omega_y(\mathbf{p},t) & = & -\alpha \kappa \cos\psi \cos\xi \cos(\omega t - \boldsymbol{\kappa} \cdot \mathbf{p} + \phi) \\
      \omega_z(\mathbf{p},t) & = & 0 \,.
   \end{eqnarray*}

More details on the analysis of rotational motions are found in [Maranò_et_al_2014]_.

Rayleigh wave with circular wavefront
-------------------------------------

The model described in :eq:`RayleighWave` assumes planar wavefront. This assumption is suitable when the source is located far from the array of sensors. Whenever the source is close or even within the array the curvature of the wavefront need to be taken into account. In applications, this is necessary in active seismic surveying.

The following describe a Rayleigh wave accounting for the curved wavefront and for the amplitude decay due to geometrical spreading. The quantity :math:`r` denotes the distance of the generic position :math:`\mathbf{p}` from the source :math:`\mathbf{p}_{s}`

.. math::
   :label: RayleighWaveCircular
   :nowrap:

   \begin{eqnarray*}
      u_x(\mathbf{p},\omega) & = & -\sin \xi \, \cos \psi \, H_{1}^{(2)}(\boldsymbol{\kappa} r) \, s(\omega) \\
      u_y(\mathbf{p},\omega) & = & -\sin \xi \, \sin \psi \, H_{1}^{(2)}(\boldsymbol{\kappa} r) \, s(\omega) \\
      u_z(\mathbf{p},\omega) & = & \cos \xi \, H_{0}^{(2)}(\boldsymbol{\kappa} r) \, s(\omega) \,,
   \end{eqnarray*}

where :math:`\xi` is the ellipticity angle of the Rayleigh wave, :math:`\psi` is the azimuth angle formed by the vector :math:`\mathbf{p}-\mathbf{p}_{s}` and measured counter-clockwise from the :math:`x`-axis, :math:`\boldsymbol{\kappa}=2\pi/\lambda` is the wavenumber, and :math:`\lambda` is the wavelength. With :math:`H_{\nu}^{(2)}` we denote Hankel functions of the second kind of order :math:`\nu`. The quantity :math:`s(\omega)` is the spectrum of the source function.

More details on the joint analysis of active and passive surveys are found in [Maranò_et_al_2017b]_.

.. _secRelationship:

Relationship Between Classical H/V Ellipticity and Ellipticity Angle
********************************************************************

We now explain the relationship between two representations of Rayleigh wave ellipticity: the classical H/V ellipticity and the ellipticity angle. We clarify how they can be fairly compared and outline the advantages of the latter representation. In practical terms, one can think of classical ellipticity as a quantity closely related to the empirical H/V ratio and the ellipticity angle as the parameter :math:`\xi` estimated by WaveDec.

In literature, Rayleigh wave ellipticity is referred to as the ratio of the amplitude on the radial component and on the vertical component, i.e., the :math:`\textrm{H}/\textrm{V}` ellipticity. Considering equation Eq. :eq:`RayleighWave` and defining :math:`\textrm{H}=\left|\alpha\sin\xi\right|` and :math:`\textrm{V}=\left|\alpha\cos\xi\right|`, it follows that

.. math::
   :nowrap:

   \begin{eqnarray*}
     \frac{\textrm{H}}{\textrm{V}}=\frac{\left|\alpha\sin\xi\right|}{\left|\alpha\cos\xi\right|}=\left|\tan\xi\right|\,.
   \end{eqnarray*}

Note that there is no information about the sense of rotation of the particle in the :math:`\textrm{H}/\textrm{V}` ratio as the sign of :math:`\tan\xi` is lost. By considering directly the ellipticity angle :math:`\xi` it is possible to preserve this information and infer the sense of particle rotation.

The figure below depicts the two different representations for Rayleigh wave ellipticity in the case of a layer over half space and clarifies this idea. Namely, the `SESAME <http://sesame.geopsy.org/>`__ structural model M2.1 is used.  It is known from literature that in such a model the motion of the fundamental mode is retrograde at low frequencies. At each singularity (i.e., either :math:`\textrm{H}=0` or :math:`\textrm{V}=0`) the sense of rotation changes from retrograde to prograde or vice versa.

.. _figEllipticityRepresentationM21:

.. figure:: images/M2.1_RayleighEllipticityRepresentation.png
  :alt: Rayleigh wave Ellipticity for the SESAME M2.1 model
  :align: center
  :width: 80%
  :figwidth: 80%
  :figclass: align-center

  (a) Classical H/V ellipticity and (b) ellipticity angle representation of Rayleigh wave ellipticity for the SESAME M2.1 model.
  On the right of (b), the particle motion is sketched for different values of the ellipticity angle and for a wave propagating from left to right. :download:`Download image (PDF).<AdditionalFiles/M2.1_RayleighEllipticityRepresentation.pdf>`


Firstly, we look at the fundamental mode (solid red line) in the :math:`\textrm{H}/\textrm{V}` representation of (a). The particle motion is retrograde up to 2vHz, where the first singularity occurs and the particle motion is horizontally polarized. Between 2 Hz and 3.8 Hz the particle motion is prograde, at 3.8 Hz the wave is vertically polarized. Above 3.8 Hz the motion is again retrograde. We stress that from this picture it is not possible to get any information about the sense of rotation of the particle and we are allowed to draw the previous considerations only because of the prior knowledge about the model.

Secondly, in (b) the ellipticity is represented by means of the ellipticity angle :math:`\xi`. As explained earlier in this section, the particle motion is retrograde when :math:`\xi\in\left(-\pi/2,0\right)` and it is prograde when :math:`\xi\in\left(0,\pi/2\right)`. The polarization is vertical for :math:`\xi=0` and horizontal for :math:`\xi=\pm\pi/2`. Similar considerations can be made for the higher modes, which are not depicted here.

Overview of the WaveDec method
##############################

We analyse array recordings of ambient vibrations using the WaveDec software, which implements the algorithm presented in [Maranò_et_al_2012]_. Wavefield parameters :math:`\boldsymbol{\theta}` are estimated following the Maximum Likelihood (ML) criterion. For Love and Rayleigh waves estimated parameters include wavenumber and direction of arrival. For Rayleigh waves, the ellipticity angle is also estimated. The algorithm jointly processes the three sensors components and provides an estimate of Rayleigh wave ellipticity together with the sense of rotation (i.e., prograde vs. retrograde particle motion). The simultaneous presence of multiple Love and Rayleigh waves is accounted for. The number of waves modelled is gradually increased by the algorithm and wave parameters are iteratively re-estimated. The type and the number of waves modelled are chosen adaptively from the algorithm following a statistical criterion. As it will be clear from our results, there is a significant improvement when considering jointly multiple waves of multiple types.

Measurement model
*****************

We rely on noisy measurements from :math:`L`  channels. In the case of :math:`N` three-component sensors, we have :math:`L=3N`. In particular, on the :math:`\ell`-th channel the measurements :math:`Y_{k}^{(\ell)}` at discrete instants :math:`t_{k}` are 

.. math::
   :nowrap:

   \begin{eqnarray*}
     Y_{k}^{(\ell)}=u(\mathbf{p}_{\ell},t_{k})+Z_{k}^{(\ell)}\,\textrm{for}\, k=1,\ldots,K\,,
   \end{eqnarray*}

where :math:`u(\mathbf{p}_{\ell},t_{k})` is a deterministic function with unknown wavefield parameters and :math:`Z_{k}^{(\ell)}` is zero-mean additive white Gaussian noise with variance :math:`\sigma_{\ell}^{2}`.

With this signal model, the probability density function (PDF) of the observations :math:`\mathbf{y}` of :math:`\mathbf{Y}` is 

.. math::
   :label: pdfIID
   :nowrap:

   \begin{eqnarray*}
     p(y|\boldsymbol{\theta})	=\prod_{\ell=1}^{L}\prod_{k=1}^{K}\frac{1}{\sqrt{2\pi\sigma_{\ell}^{2}}}\textrm{e}^{-\left(y_{k}^{(\ell)}-u_{k}^{(\ell)}\right)^{2}/2\sigma_{\ell}^{2}}\,,
   \end{eqnarray*}


where we grouped all the measurement as :math:`y = \{y_{k}^{(\ell)}\}` and defined :math:`u_{k}^{(\ell)} = u(\mathbf{p}_{\ell},t_{k})`.

In the proposed technique, instead of computing the likelihood of the observation directly from :eq:`pdfIID`, we model it by means of a `factor graph <https://en.wikipedia.org/wiki/Factor_graph>`_. This enables the algorithm a more efficient computation of the likelihood.

Maximum likelihood estimation
*****************************

An ML estimate :math:`\boldsymbol{\hat{\theta}}` is found maximizing the likelihood function

.. math::
   :nowrap:

   \begin{eqnarray*}
     \boldsymbol{\hat{\theta}} = \textrm{argmax}_{\boldsymbol{\theta}}p(y|\boldsymbol{\theta})\,.
   \end{eqnarray*}

This maximization is performed analytically for the parameters :math:`\alpha` and :math:`\phi`. It is performed numerically for the remaining parameters using a grid search first and then a numerical optimization routine.

Model selection
***************

In the seismic wavefield several waves of different functional forms are present simultaneously. This interference can severely downgrade the quality of the analysis. WaveDec follows an approach, called wavefield decomposition, enabling us to separate the contribution of different waves and improving the accuracy of the parameter estimation. In the proposed technique the composition of the wavefield can vary in time. The number of waves modelled by the algorithm is increased gradually. Each estimated parameter vector benefits from the estimation of the other waves as the parameter estimation of each wave is repeated iteratively.

We use a penalized version of Bayesian information criterion (BIC) where a scalar :math:`\gamma` allows to control the complexity of the model. The penalized BIC is defined as

.. math::
   :nowrap:

   \begin{eqnarray*}
     \textrm{BIC}_{\gamma}=-2p(y|\boldsymbol{\theta})+\gamma N_{p}\ln(LK)\,,
   \end{eqnarray*}

where :math:`N_{p}` denotes the number of parameters of the statistical model and :math:`LK` is the number of measurements. The parameter :math:`\gamma\geq0` enables us to follow a pure BIC model selection strategy for :math:`\gamma=1`, an ML approach (which will result in overfitting) for :math:`\gamma=0`, or any intermediate strategy for different values :math:`\gamma\in\left(0,1\right)`.

Example applications
####################

In this section, we present some results obtained with WaveDec and WaveDecActive. For more details see [Maranò_et_al_2017a]_.

SESAME M2.1
***********

We first consider ambient vibrations from a high-fidelity synthetic wavefield. The dataset was created
within the `SESAME project <http://sesame.geopsy.org/>`_. We consider a model of a layer of softer sediments
over an half-space with higher velocity.

.. figure:: images/M2.1/LoveWaves_L0_Wavenumber.png
  :alt: Wavenumber L0
  :align: center
  :width: 80%
  :figwidth: 40%
  :figclass: align-center

  Estimated Love wave wavenumber, fundamental mode.

The picture above show the estimated Love wave dispersion curve for the fundamental mode. 
Estimated values and their uncertainty is shown with a blue solid line. Theoretical values are shown with the green solid line.

+---------------------------------------------------------------+----------------------------------------------------------------------+
|                                                               |                                                                      |
| .. figure:: images/M2.1/RayleighWaves_R0_Wavenumber_B.png     | .. figure:: images/M2.1/RayleighWaves_R0_EllipticityAngle.png        |
|   :alt: Wavenumber R0                                         |   :alt: Ellipticty angle R0                                          |
|   :width: 80%                                                 |   :width: 80%                                                        |
|   :figwidth: 90%                                              |   :figwidth: 85%                                                     |
|   :figclass: align-center                                     |   :figclass: align-center                                            |
|                                                               |                                                                      |
|   Estimated Rayleigh wave wavenumber, fundamental mode.       |   Estimated Rayleigh wave ellipticty angle, fundamental mode.        |
+---------------------------------------------------------------+----------------------------------------------------------------------+

The pictures above show the estimated Rayleigh wave dispersion curve (left) and the Rayleigh wave ellipticity angle (right) for the fundamental mode. 
From the left picture we infer that the particle motion of the Rayleigh wave fundamental mode is prograde
above 2 Hz until 3.8 Hz, i.e. :math:`\xi > 0`. At 3.8 Hz the particle is vertically polarized. Above this frequency
the wave has a retrograde particle motion, i.e. :math:`\xi < 0`. This is a standard behaviour of the ellipticity
angle curve in presence of a single interface with a strong velocity contrast.


+---------------------------------------------------------------+----------------------------------------------------------------------+
|                                                               |                                                                      |
| .. figure:: images/M2.1/RayleighWaves_R1_Wavenumber_B.png     | .. figure:: images/M2.1/RayleighWaves_R1_EllipticityAngle.png        |
|   :alt: Wavenumber R1                                         |   :alt: Ellipticty angle R1                                          |
|   :width: 80%                                                 |   :width: 80%                                                        |
|   :figwidth: 90%                                              |   :figwidth: 85%                                                     |
|   :figclass: align-center                                     |   :figclass: align-center                                            |
|                                                               |                                                                      |
|   Estimated Rayleigh wave wavenumber, first higher mode.      |   Estimated Rayleigh wave ellipticty angle, first higher mode.       |
+---------------------------------------------------------------+----------------------------------------------------------------------+

The pictures above show the estimated Rayleigh wave dispersion curve (left) and the Rayleigh wave ellipticity angle (right) for the first higher mode.

.. figure:: images/M2.1/HV.png
  :alt: Rayleigh wave Ellipticity and H/V ratio
  :align: center
  :width: 80%
  :figwidth: 40%
  :figclass: align-center

  Comparison of H/V ratios (red lines) and ellipticity angle (blue lines, two modes), and theoretical values (green).


In the figure above, the H/V ratios of each sensor are compared with the ellipticity curves from array processing.
The result of each sensor is depicted with a light red line while the average H/V of all stations
is solid red. The ellipticity curve for the fundamental mode is depicted with a solid blue line and the
curve for the first higher mode with a dashed blue line. The ellipticity of both the fundamental mode
and the first higher mode are in good agreement with the theoretical values (depicted in green). The
only slight deviation from the theoretical values is observed below 3 Hz. We observe that this frequency
corresponds to the frequency where the dispersion curve intersects the lower array resolution
limit and can thus be explained with a loss of resolution of the array. Above 3 Hz, the right
flank of the H/V peak agrees well with the ellipticity curve of the fundamental mode. The location of
the trough at just below 4 Hz can be understood rather clearly both from the H/V ratios and from the
ellipticity curve. A singularity at 5 Hz is only seen as a sharp peak from the ellipticity curve of the first
higher mode while is not seen in the H/V ratios.


.. _secJointModeling:

Benefit of joint modeling Rayleigh and Love waves
-------------------------------------------------

By modeling jointly both Rayleigh and Love waves, the accuracy of the estimated parameters is improved. We consider the 
retrieval of Rayleigh wave ellipticty when modeling i) both Rayleigh and Love waves and ii) modeling only Rayleigh waves and ignoring
Love waves. The SESAME M2.1 model is used. This example is presented in [Maranò_et_al_2017a]_.


+---------------------------------------------------------------+----------------------------------------------------------------------+
|                                                               |                                                                      |
| .. figure:: images/M2.1/RayleighWaves_R0_EllipticityAngle.png | .. figure:: images/M2.1/woLove_RayleighWaves_R0_EllipticityAngle.png |
|   :alt: Ellipticty angle R0                                   |   :alt: Ellipticty angle R0                                          |
|   :width: 80%                                                 |   :width: 80%                                                        |
|   :figwidth: 90%                                              |   :figwidth: 85%                                                     |
|   :figclass: align-center                                     |   :figclass: align-center                                            |
|                                                               |                                                                      |
|   Rayleigh wave ellipticty angle, fundamental mode.           |   Rayleigh wave ellipticty angle, fundamental mode.                  |
|   Both Rayleigh and Love waves are modeled by WaveDec.        |   Only Rayleigh waves are modeled my WaveDec.                        |
+---------------------------------------------------------------+----------------------------------------------------------------------+


Figures above show the ellipticity angle of the fundamental mode when modelling both Love and Rayleigh waves (left) and when
modelling only Rayleigh waves and ignoring Love waves (right). The deviation of the picked ellipticity
angle curve with respect to the theoretical values around 3 Hz is immediately evident on the right-hand picture. In particular,
there is a systematic shift of the curve towards higher values of the ellipticity angle, corresponding to a more horizontally polarized particle motion.
In other words, by not modeling Love waves, there is more energy unexplained by the algorithm on the horizontal components and this lead to a wrong estimate of the
Rayleigh wave ellipticty angle.

.. _figElliptictyDifference:

.. figure:: images/M2.1/R0_LoveEffect.png
  :alt: Rayleigh wave Ellipticity angle
  :align: center
  :width: 80%
  :figwidth: 70%
  :figclass: align-center

  Difference between estimated and theoretical ellipticity angle.


Fig. :ref:`figElliptictyDifference` depicts the differences between the estimated and the true ellipticity angle for the fundamental mode. The red line depicts the difference obtained
when WaveDec is modelling jointly Rayleigh and Love waves. The blue line depicts the difference
obtained when only Rayleigh waves are modelled and Love waves ignored. It is immediately possible to observe that without
modelling Love waves there is a large deviation in the estimated Rayleigh ellipticity angle between
2.5 and 3.8 Hz. When the Love waves are also modelled, the bias is smaller and only present below
3 Hz. We note that the lower resolution limit of the array is at 3 Hz, so the deviation from the true
curve may also be related to this fact.

We conclude that ignoring the presence of Love waves can result in a bias in the recovered
Rayleigh wave ellipticity. In fact the ellipticity angle is larger, suggesting a more horizontally polarized
Rayleigh wave than in reality. This is reasonable since the energy of Love waves is limited to
the horizontal components. By jointly modelling both Love and Rayleigh waves using WaveDec it is
possible to mitigate such a bias.


Davos (SDAK)
************

The site `SDAK <http://stations.seismo.ethz.ch/opencms8/opencms/seddb/station_information_public/station_given_networkcode_and_stationcode.html?networkcode=CH&stationcode=SDAK>`_ in Davos, Canton of Grisons is located in the centre of a narrow sedimentary basin
of around 500 m width in the Swiss Alps. The underground is composed of alluvial deposits of the
Landwasser river. Previous site studies suggest that the site has a :math:`V_{s30} = 242\,\textrm{m/s}`. We denote with
:math:`V_{s30}` the average velocity of shear waves in the superficial 30 meters.

This site is representative of a common situation where we have a single very strong contrast.
For most stations, H/V ratios depicted below with red lines exhibit a clear peak around 1.5 Hz
and a trough at 2.5 Hz. However, we observe that for some stations located at the edge of the basin
the resonance frequency is shifted to higher values. In the same figure, the Rayleigh wave ellipticity
(blue line) retrieved from the array allows us to pinpoint very clearly the location of the trough. We
used all the available stations for the retrieval of the ellipticity angle using the array, disregarding the
fact that some stations exhibit different H/V. We expect the ellipticity retrieved from the array to be
representative of the average structure of the site.


+---------------------------------------------------------------+---------------------------------------------------------------+
|                                                               |                                                               |
| .. figure:: images/SDAK/RayleighWaves_R0_Wavenumber_B.png     | .. figure:: images/SDAK/RayleighWaves_R0_EllipticityAngle.png |
|   :alt: Wavenumber R0                                         |   :alt: Ellipticty angle R0                                   |
|   :width: 80%                                                 |   :width: 80%                                                 |
|   :figwidth: 90%                                              |   :figwidth: 85%                                              |
|   :figclass: align-center                                     |   :figclass: align-center                                     |
|                                                               |                                                               |
|   Rayleigh wave wavenumber, fundamental mode.                 |   Rayleigh wave ellipticty angle, fundamental mode.           |
+---------------------------------------------------------------+---------------------------------------------------------------+

The figures above depict the estimated wavenumber and ellipticity angle from the array recording. The
dispersion curve is picked until just below 2 Hz due to the lower resolution limit. The ellipticity angle
shows prograde particle motion between the lower frequency limit and the singularity at 2.5 Hz. At
2.5 Hz the particle motion is vertically polarized, above this frequency the ellipticity angle is constant
and the particle motion is retrograde.

.. figure:: images/SDAK/HV.png
  :alt: Rayleigh wave Ellipticity and H/V ratio
  :align: center
  :width: 80%
  :figwidth: 40%
  :figclass: align-center

  Comparison of H/V ratios (red lines) and ellipticity angle (blue lines, two modes).

We now consider the ellipticity retrieved from the array and the average H/V ratio, shown in
The figure above. At low frequencies, the ellipticity is limited by the resolution of the array and does not allow
us to identify accurately the fundamental frequency of the site. On the right flank of the peak, there
is a discrepancy between the H/V ratio and the array ellipticity. The H/V ratio exhibits larger values
than the array ellipticity and this could be explained by the presence of Love waves in the wavefield.
As discussed in the previous sections, WaveDec models the presence of Love waves and thus reduces
their impact on the estimated ellipticity. The trough at 2.5 Hz is very clearly identified looking at the
array ellipticity but it is not as easily identified from H/V ratios. One reason could be that the presence
of Love waves in the wavefield augments the energy on the horizontal components and thus increases
the value of the H/V ratio.



Zurich Airport (SKLW) - Passive
*******************************

The site `SKLW <http://stations.seismo.ethz.ch/opencms8/opencms/seddb/station_information_public/station_given_networkcode_and_stationcode.html?networkcode=CH&stationcode=SKLW>`_ in Kloten, Canton of Zurich is located on a large glacial gravel terrace in a wide, but
shallow basin. The array is located in close vicinity of the airport of Zurich.

+---------------------------------------------------------------+---------------------------------------------------------------+
|                                                               |                                                               |
| .. figure:: images/SKLW/RayleighWaves_R0_Wavenumber_B.png     | .. figure:: images/SKLW/RayleighWaves_R0_EllipticityAngle.png |
|   :alt: Wavenumber R0                                         |   :alt: Ellipticty angle R0                                   |
|   :width: 80%                                                 |   :width: 80%                                                 |
|   :figwidth: 90%                                              |   :figwidth: 85%                                              |
|   :figclass: align-center                                     |   :figclass: align-center                                     |
|                                                               |                                                               |
|   Rayleigh wave wavenumber, fundamental mode.                 |   Rayleigh wave ellipticty angle, fundamental mode.           |
+---------------------------------------------------------------+---------------------------------------------------------------+


Wavenumber and ellipticity angle estimates for the fundamental mode are shown in Figs. 7c
and 7d, respectively. The ellipticity angle of the fundamental mode exhibits a common pattern from
prograde above the resonance frequency to retrograde at higher frequencies.

+---------------------------------------------------------------+---------------------------------------------------------------+
|                                                               |                                                               |
| .. figure:: images/SKLW/RayleighWaves_R1_Wavenumber_B.png     | .. figure:: images/SKLW/RayleighWaves_R1_EllipticityAngle.png |
|   :alt: Wavenumber R1                                         |   :alt: Ellipticty angle R1                                   |
|   :width: 80%                                                 |   :width: 80%                                                 |
|   :figwidth: 90%                                              |   :figwidth: 85%                                              |
|   :figclass: align-center                                     |   :figclass: align-center                                     |
|                                                               |                                                               |
|   Rayleigh wave wavenumber, fundamental mode.                 |   Rayleigh wave ellipticty angle, fundamental mode.           |
+---------------------------------------------------------------+---------------------------------------------------------------+

Wavenumber and ellipticity angle estimates for the first higher mode are shown in Figs. 7e and 7f,
respectively. The ellipticity angle of the first higher mode indicates prograde particle motion over the
entire frequency range. At about 9 Hz the wave is almost horizontally polarized, above this frequency,
the value of the ellipticity angle decreases slightly.

.. figure:: images/SKLW/HV.png
  :alt: Rayleigh wave Ellipticity and H/V ratio
  :align: center
  :width: 80%
  :figwidth: 40%
  :figclass: align-center

  Comparison of H/V ratios (red lines) and ellipticity angle (blue lines, two modes).

In this figure the H/V ratios are compared with the ellipticity of two modes. Peak and trough of the
H/V ratios are not very clearly identified, possibly due to the lack of a strong contrast. On the contrary,
the WaveDec ellipticity angle information allows us to pinpoint the trough very accurately.

Zurich Airport (SKLW) - Active
******************************

With an active source in the proximity of the array, we employ the wave equations :eq:`RayleighWaveCircular`. We are able to retrieve dispersion curve at higher frequencies, complementing the information retrieved with the passive survey.

.. note:: To be completed.
   This section pertains to the work presented in [Maranò_et_al_2017b]_.



Baar (SBAS)
***********

The site `SBAS <http://stations.seismo.ethz.ch/opencms8/opencms/seddb/station_information_public/station_given_networkcode_and_stationcode.html?networkcode=CH&stationcode=SBAS>`_ in Baar, Canton of Zug lies on the alluvial cone of the Lorze river, about 2.5 km
from the mouth of the river in Lake Zug. The underground geology consists of gravel, sand, and silt.
Previous site studies determined :math:`V_{s30} = 203\,\textrm{m/s}`.

+---------------------------------------------------------------+---------------------------------------------------------------+
|                                                               |                                                               |
| .. figure:: images/SBAS/RayleighWaves_R0_Wavenumber_B.png     | .. figure:: images/SBAS/RayleighWaves_R0_EllipticityAngle.png |
|   :alt: Wavenumber R0                                         |   :alt: Ellipticty angle R0                                   |
|   :width: 80%                                                 |   :width: 80%                                                 |
|   :figwidth: 90%                                              |   :figwidth: 85%                                              |
|   :figclass: align-center                                     |   :figclass: align-center                                     |
|                                                               |                                                               |
|   Rayleigh wave wavenumber, fundamental mode.                 |   Rayleigh wave ellipticty angle, fundamental mode.           |
+---------------------------------------------------------------+---------------------------------------------------------------+

The figure on the left shows wavenumber estimates with the picked fundamental mode of the Rayleigh wave.
The figure on the right depicts the corresponding ellipticity angle estimates are shown. Rayleigh wave ellipticity
exhibits several singularities where the particle motion switches from prograde to retrograde or viceversa. The particle motion is prograde until 2.5 Hz, where the polarization is purely vertical. Until
3.5 Hz the particle motion is retrograde. At 3.5 Hz, the particle motion is purely horizontal. From
3.5 Hz until just above 6 Hz the motion is prograde and finally changes to retrograde one last time.

.. figure:: images/SBAS/HV.png
  :alt: Rayleigh wave Ellipticity and H/V ratio
  :align: center
  :width: 80%
  :figwidth: 40%
  :figclass: align-center

  Comparison of H/V ratios (red lines) and ellipticity angle (blue line).

The H/V ratio curves shown above exhibit multiple peaks and troughs. The peak above 1 Hz identifies
the fundamental frequency of the site and the other peak, just above 3.5 Hz, witnesses the presence
of another shallower contrast. The ellipticity of the fundamental mode of the Rayleigh wave shows a
good agreement with the H/V ratios. The trough at 2.5 Hz is identified at the same frequency from
both H/V and ellipticity. The peak around 3-4 Hz is also found with both methods, with a minor
discrepancy. For the second trough, around 6-7 Hz, there is a discrepancy between H/V ratios and ellipticity.
We observe that the H/V curves are quite different in this frequency range, possibly reflecting
inhomogeneities of the subsurface. The array ellipticity is probably most representative of the average
structure below the array. We remark that the ellipticity curve allows to pinpoint much more clearly
the frequency of the singularities with respect to the H/V ratio.

Despite the many singularities observed at this site, usingWaveDec it is possible to easily identify
the dispersion curve over a broad frequency range. This would not be possible when modelling the
vertical and the radial component separately. In fact, we observed that using the method proposed
in Poggi & Fäh (2010) there is a lack of energy on the vertical (radial) component when the Rayleigh
wave is horizontally (vertically) polarized.

.. _secEllipticitySites:

Rayleigh wave ellipticity at different sites
********************************************

A quick comparison of ellipticity angle curves retrieved at selected sites. All the curves refer to the fundamental mode of the Rayleigh wave. More details and discussion are found in [Maranò_et_al_2017a]_.


+-------------------------------------------------------------------+--------------------------------------------------------------------+
|                                                                   |                                                                    |
| .. figure:: images/Ell/SDAK_RayleighWaves_R0_EllipticityAngle.png | .. figure:: images/Ell/SBAS_RayleighWaves_R0_EllipticityAngle.png  |
|   :alt: Ellipticty angle R0                                       |   :alt: Ellipticty angle R0                                        |
|   :width: 80%                                                     |   :width: 80%                                                      |
|   :figwidth: 90%                                                  |   :figwidth: 85%                                                   |
|   :figclass: align-center                                         |   :figclass: align-center                                          |
|                                                                   |                                                                    |
|   Single interface, Davos (SDAK).                                 |   Two contrasts, Baar (SBAS).        	                         |
+-------------------------------------------------------------------+--------------------------------------------------------------------+
|                                                                   |                                                                    |
| .. figure:: images/Ell/SBAK_RayleighWaves_R0_EllipticityAngle.png | .. figure:: images/Ell/SCUG_RayleighWaves_R0_EllipticityAngle.png  |
|   :alt: Ellipticty angle R0                                       |   :alt: Ellipticty angle R0                                        |
|   :width: 80%                                                     |   :width: 80%                                                      |
|   :figwidth: 90%                                                  |   :figwidth: 85%                                                   |
|   :figclass: align-center                                         |   :figclass: align-center                                          |
|                                                                   |                                                                    |
|   Gradient, Basel Klybeck (SBAK).                                 |   Rock site, Chur (SCUG).        	                                 |
+-------------------------------------------------------------------+--------------------------------------------------------------------+



